*  *&---------------------------------------------------------------------*
*& Report  ZPOTENCY_NEW1
*& Develiped by Jyotsna
* This sheet will help in dispencing production material in production order CO01 for active raw materail
*&---------------------------------------------------------------------*
*&FEFO concept is introduced on 28.6.24.
*&POTENCY IS MAPPED FROM RESULT RECORDING IN QE51 FOR MIC 'POTENCY1' w.e.f 1.10.24- Jyotsna
********** lwedt sort criteria is added on 19.11.24 for stock sorting- Jyotsna
**********following changes made on 26.11.24 for Goa adjusted material by Jyotsna
* IF NSTOCK1 GT STOCK.
*        STOCK = NSTOCK1.
*      ENDIF.
* **stock2 = 0. "added on 6.1.25  if stock is available - line
****added provision to take FIFPO for required materil if in-use material exist - 10.2.25
*** added calculated at all stages for Goa adjusted stock on 2.6.25- Jyotsna
*&---------------------------------------------------------------------*
REPORT ZPOTENCY_NEW8 NO STANDARD PAGE HEADING LINE-SIZE 160.

TABLES : MARA,
         MCHB,
         MAST,
         STKO,
         QAMV,
         QAMR,
         MAKT,
         MARM,
         ZINSPPOT,
         T001W,
         ZPOTENCY_BOM1,
         ZPOTENCY_INC,
         ZPOTENCY_API,
         JEST,
         MCHA.

TYPE-POOLS:  SLIS.

DATA: G_REPID     LIKE SY-REPID,
      FIELDCAT    TYPE SLIS_T_FIELDCAT_ALV,
      WA_FIELDCAT LIKE LINE OF FIELDCAT,
      SORT        TYPE SLIS_T_SORTINFO_ALV,
      WA_SORT     LIKE LINE OF SORT,
      LAYOUT      TYPE SLIS_LAYOUT_ALV.

RANGES : LR_ATINN  FOR AUSP-ATINN.

DATA : V_FM TYPE RS38L_FNAM.
DATA : CONTROL  TYPE SSFCTRLOP.
DATA : W_SSFCOMPOP TYPE SSFCOMPOP.

DATA: IT_MAST TYPE TABLE OF MAST,
      WA_MAST TYPE MAST,
      IT_STAS TYPE TABLE OF STAS,
      WA_STAS TYPE STAS,
      IT_STPO TYPE TABLE OF STPO,
      WA_STPO TYPE STPO,
      IT_MCHB TYPE TABLE OF MCHB,
      WA_MCHB TYPE MCHB,
      IT_RESB TYPE TABLE OF RESB,
      WA_RESB TYPE RESB,
      IT_QALS TYPE TABLE OF QALS,
      WA_QALS TYPE QALS.

DATA: IT_MAST_1 TYPE TABLE OF MAST,
      WA_MAST_1 TYPE MAST,
      IT_STKO_1 TYPE TABLE OF STKO,
      WA_STKO_1 TYPE STKO.

TYPES : BEGIN OF ITAB1,
          MATNR TYPE MCHB-MATNR,
          MENGE TYPE STPO-MENGE,
          MEINS TYPE STPO-MEINS,
          POSNR TYPE STPO-POSNR,
          SORTF TYPE MARA-MATNR,
          POTX1 TYPE STPO-POTX1,
*          COUNT(2) TYPE C,
        END OF ITAB1.

TYPES : BEGIN OF ITAB2,
          MATNR    TYPE MARA-WRKST,
          MENGE    TYPE STPO-MENGE,
          MEINS    TYPE STPO-MEINS,
          POSNR    TYPE STPO-POSNR,
          SORTF    TYPE MARA-MATNR,
          POTX1    TYPE STPO-POTX1,
          COUNT(2) TYPE C,
        END OF ITAB2.

TYPES : BEGIN OF ADJ1,
          MATNR TYPE MCHB-MATNR,
          MENGE TYPE STPO-MENGE,
          MEINS TYPE STPO-MEINS,
          POSNR TYPE STPO-POSNR,
        END OF ADJ1.

TYPES : BEGIN OF ADJ2,
          MATNR    TYPE MARA-WRKST,
          MENGE    TYPE STPO-MENGE,
          MEINS    TYPE STPO-MEINS,
          POSNR    TYPE STPO-POSNR,
          COUNT(2) TYPE C,
        END OF ADJ2.

TYPES : BEGIN OF MAT1,

          ADJPOSNR TYPE STPO-POSNR,
          POSNR    TYPE STPO-POSNR,
          MATNR    TYPE MARA-WRKST,
          MENGE    TYPE STPO-MENGE,
          MENGE1   TYPE STPO-MENGE,
          MEINS    TYPE STPO-MEINS,

          ADJMATNR TYPE MARA-WRKST,
          ADJMENGE TYPE STPO-MENGE,
          ADJMEINS TYPE STPO-MEINS,
          SORTF    TYPE STPO-SORTF,
          CNT(2)   TYPE C,
          COUNT(2) TYPE C,
          POTX1    TYPE STPO-POTX1,

*          POSNR    TYPE STPO-POSNR,
*          MATNR    TYPE MARA-WRKST,
*          MENGE    TYPE STPO-MENGE,
*          MENGE1   TYPE STPO-MENGE,
*          MEINS    TYPE STPO-MEINS,
*          ADJPOSNR TYPE STPO-POSNR,
*          ADJMATNR TYPE MARA-WRKST,
*          ADJMENGE TYPE STPO-MENGE,
*          ADJMEINS TYPE STPO-MEINS,
*          SORTF    TYPE STPO-SORTF,
*          CNT(2)   TYPE C,
*          COUNT(2) TYPE C,
*          POTX1    TYPE STPO-POTX1,
        END OF MAT1.

TYPES : BEGIN OF STK1,
          MATNR TYPE MARA-MATNR,
        END OF STK1.

TYPES : BEGIN OF POT1,
          COUNT(2) TYPE C,
          MATNR    TYPE MARA-MATNR,
          POTX1    TYPE STPO-POTX1,
          CHARG    TYPE MCHB-CHARG,
          STOCK    TYPE MCHB-CLABS,
          TQTY2    TYPE P DECIMALS 3,
          PRUEFLOS TYPE QALS-PRUEFLOS,
*          P3       TYPE P DECIMALS 2,
          P3(10)   TYPE C,
          TEXT(50) TYPE C,
          QTY1     TYPE P DECIMALS 3,
          QTY11    TYPE P DECIMALS 3,
          DQTY     TYPE P DECIMALS 3,
          DQTY11   TYPE P DECIMALS 3,
          NQTY1    TYPE P DECIMALS 3,
          NQTY11   TYPE P DECIMALS 3,
        END OF POT1.

TYPES : BEGIN OF POT2,
          SR(3)     TYPE C,
          CHARG     TYPE MCHB-CHARG,
          PRUEFLOS  TYPE QALS-PRUEFLOS,
          STOCK(10) TYPE C,
          P3(10)    TYPE C,
          NQTY1(10) TYPE C,
          DQTY(10)  TYPE C,
        END OF POT2.

TYPES : BEGIN OF POS1,
          COUNT(2)     TYPE C,
          ADJMATNR     TYPE MARA-MATNR,
          STOCK2       TYPE MCHB-CLABS,
          ESTOCK       TYPE MCHB-CLABS,
          AMAKTX(100)  TYPE C,
          BMAKTX(100)  TYPE C,
          BMAKTX1(100) TYPE C,
          BMAKTX2(100) TYPE C,
          AQTY1        TYPE P DECIMALS 3,
          ADJQTY       TYPE P DECIMALS 3,

        END OF POS1.

TYPES : BEGIN OF ZMCHB,
          MATNR TYPE MCHB-MATNR,
          WERKS TYPE MCHB-WERKS,
          LGORT TYPE MCHB-LGORT,
          CHARG TYPE MCHB-CHARG,
          CLABS TYPE MCHB-CLABS,
          VFDAT TYPE MCHA-VFDAT,
          LWEDT TYPE MCHA-LWEDT,

        END OF ZMCHB.

TYPES : BEGIN OF TY_MCH1,
          OBJEK TYPE CHAR90,
          MATNR TYPE MATNR,
          CHARG TYPE CHARG_D,
        END OF TY_MCH1.

DATA : IT_MCH1 TYPE TABLE OF TY_MCH1,
       WA_MCH1 TYPE TY_MCH1.

DATA: IT_TAB1          TYPE TABLE OF ITAB1,
      WA_TAB1          TYPE ITAB1,
      IT_TAB2          TYPE TABLE OF ITAB2,
      WA_TAB2          TYPE ITAB2,
      IT_ADJ1          TYPE TABLE OF ADJ1,
      WA_ADJ1          TYPE ADJ1,
      IT_ADJ2          TYPE TABLE OF ADJ2,
      WA_ADJ2          TYPE ADJ2,
      IT_MAT1          TYPE TABLE OF MAT1,
      WA_MAT1          TYPE MAT1,
      IT_STK1          TYPE TABLE OF STK1,
      WA_STK1          TYPE STK1,
      IT_POT1          TYPE TABLE OF POT1,
      WA_POT1          TYPE POT1,
      IT_POT2          TYPE TABLE OF POT2,
      WA_POT2          TYPE POT2,
      IT_POS1          TYPE TABLE OF POS1,
      WA_POS1          TYPE POS1,
      IT_ZPOTENCY_BOM1 TYPE TABLE OF ZPOTENCY_BOM1,
      WA_ZPOTENCY_BOM1 TYPE ZPOTENCY_BOM1,
      IT_ZMCHB         TYPE TABLE OF ZMCHB,
      WA_ZMCHB         TYPE ZMCHB.
TYPES: BEGIN OF BOM1,
         MATNR TYPE MARA-MATNR,
         STLAL TYPE STKO-STLAL,
         BMENG TYPE STKO-BMENG,
         BMEIN TYPE STKO-BMEIN,
         MAKTX TYPE MAKT-MAKTX,
       END OF BOM1.
DATA: IT_BOM1 TYPE TABLE OF BOM1,
      WA_BOM1 TYPE BOM1.
DATA : LV_P3 TYPE P DECIMALS 3 LENGTH 6.
DATA : LV_NQTY TYPE P DECIMALS 3 LENGTH 6.
DATA: ADJCNT(1) TYPE C.
DATA: AQTY1   TYPE P DECIMALS 3,
      ADJQTY  TYPE P DECIMALS 3,
      ADJQTY1 TYPE P DECIMALS 3.
DATA: POTQTY1  TYPE P DECIMALS 3,
      POTQTY2  TYPE P DECIMALS 3,
      POTQTY31 TYPE P DECIMALS 3,
      POTQTY32 TYPE P DECIMALS 3.
DATA: TOTPOTQTY1 TYPE P DECIMALS 3,
      TOTPOTQTY2 TYPE P DECIMALS 3,
      TOTPOTQTY3 TYPE P DECIMALS 3.
DATA: MENGE1(10) TYPE C.
DATA: FORMAT(100) TYPE C.
DATA: COUNT1 TYPE I.
DATA: ORT01 TYPE  T001W-ORT01.
DATA: POTQTY11(10) TYPE C,
      POTQTY12(10) TYPE C.
DATA: BCOUNT1(2) TYPE C.
DATA: PAGE1 TYPE I.
DATA: COUNT4 TYPE I.
DATA: S2(1) TYPE C.
DATA: ADJMATNR    TYPE MARA-MATNR,
      ADJPOSNR    TYPE STPO-POSNR,
      ADJCOUNT(2) TYPE C,
      ADJMENGE    TYPE STPO-MENGE,
      ADJMEINS    TYPE STPO-MEINS.
DATA: ADJTXT1     TYPE MARA-MATNR,
      ADJTXT2(20) TYPE C.
DATA: ADJMAKTX1     TYPE MAKT-MAKTX,
      ADJMAKTX2     TYPE MAKT-MAKTX,
      ADJNORMT      TYPE MARA-NORMT,
      ADJMAKTX(100) TYPE C.
DATA: ADJMAKTX11(45) TYPE C.
TYPES : BEGIN OF PMBOM1,
          STLAL TYPE MAST-STLAL,
        END OF PMBOM1.
DATA:   COUNT(2) TYPE C.
TYPES : BEGIN OF PMBOM2,
          MATNR TYPE PBIM-MATNR,
          WERKS TYPE PBIM-WERKS,
          VAL   TYPE P DECIMALS 3,
          BMENG TYPE STKO-BMENG,
          B1    TYPE P DECIMALS 3,
          STLAL TYPE MAST-STLAL,
          IDNRK TYPE STPO-IDNRK,
        END OF PMBOM2.
DATA: COUNT2(2) TYPE C.
DATA: IT_PMBOM1 TYPE TABLE OF PMBOM1,
      WA_PMBOM1 TYPE PMBOM1,
      IT_PMBOM2 TYPE TABLE OF PMBOM2,
      WA_PMBOM2 TYPE PMBOM2.
DATA: CNT TYPE I VALUE 1.
*DATA: COUNT TYPE I.
DATA : WRKST TYPE MARA-WRKST.
DATA: MAT1 TYPE MCHB-MATNR,
      MAT2 TYPE MCHB-MATNR.
DATA: ADJ TYPE MARA-MATNR.
DATA: CLABS TYPE MCHB-CLABS.
DATA: S3 TYPE I.
DATA: NSTOCK1 TYPE MCHB-CLABS.
DATA: STOCK  TYPE MCHB-CLABS,
      STOCK1 TYPE MCHB-CLABS,
      STOCK2 TYPE MCHB-CLABS.
DATA: NSTOCK3 TYPE MCHB-CLABS.
DATA: ASTOCK  TYPE MCHB-CLABS,
      ASTOCK1 TYPE MCHB-CLABS,
      ESTOCK  TYPE MCHB-CLABS.
*DATA:   COUNT(2) TYPE C.
DATA:
  NPOT1  TYPE ZINSPPOT-UPOT,
*  NPOT1 TYPE P DECIMALS 2,
  NPOT2  TYPE MCHB-CLABS,
  NNPOT2 TYPE MCHB-CLABS.
DATA: NC1 TYPE I.

DATA: QTY1   TYPE P DECIMALS 3,
      QTY11  TYPE P DECIMALS 3,
      NQTY1  TYPE P DECIMALS 3,
      NQTY11 TYPE P DECIMALS 3.
DATA: RQTY  TYPE P DECIMALS 3,
      RQTY1 TYPE P DECIMALS 3.
DATA: TQTY1 TYPE P DECIMALS 3,
      TQTY2 TYPE P DECIMALS 3.
DATA: CED  TYPE P DECIMALS 3,
      CED2 TYPE P DECIMALS 3.
DATA: S1(1) TYPE C.
DATA: AS1(1) TYPE C.
DATA: MATNR1 TYPE MARA-MATNR.
DATA: MATNR2 TYPE MARA-MATNR.
DATA: THREED TYPE I.

************************
DATA: PVAL1(10) TYPE C,
      PVAL4(10) TYPE C.
DATA : P1   TYPE QAMR-ORIGINAL_INPUT,
       P2   TYPE QAMR-ORIGINAL_INPUT,
*       p3    TYPE qamr-original_input,
       P3   TYPE P DECIMALS 3,
       NP3  TYPE P DECIMALS 3,
       OP3  TYPE P DECIMALS 3,
       NOP3 TYPE P DECIMALS 3,
       P11  TYPE QAMR-ORIGINAL_INPUT,
       P12  TYPE QAMR-ORIGINAL_INPUT,
*       p3    TYPE qamr-original_input,
       P13  TYPE P DECIMALS 3,
       Q1   TYPE MCHB-CLABS,
       QP1  TYPE P DECIMALS 3,
       QP2  TYPE P DECIMALS 3,
       Q2   TYPE P DECIMALS 3,
       Q3   TYPE P DECIMALS 3,
       Q31  TYPE MCHB-CLABS,
       QV3  TYPE  MCHB-CLABS,
       QR3  TYPE P DECIMALS 3,
       QP3  TYPE P DECIMALS 3,
*       q4     TYPE p DECIMALS 2,
       Q11  TYPE P DECIMALS 3,
       Q12  TYPE P DECIMALS 3,
       Q13  TYPE P DECIMALS 3,
       V1   TYPE P DECIMALS 3,
       V2   TYPE P DECIMALS 3,
       STK1 TYPE P DECIMALS 3.
DATA: CHK1 TYPE I.
DATA: CQTY1 TYPE MCHB-CLABS.
*DATA: ADJTXT1     TYPE MARA-MATNR,
*      ADJTXT2(20) TYPE C.
DATA: TMENGE1   TYPE STPO-MENGE,
      TMENGE2   TYPE STPO-MENGE,
      TMENGE3   TYPE STPO-MENGE,
      TOTMENGE1 TYPE STPO-MENGE.
DATA: ATXT1(200) TYPE C,
      ATXT2(200) TYPE C,
      ATXT3(200) TYPE C.
DATA: COUNT3  TYPE I,
      COUNT31 TYPE I.
DATA: THREED1 TYPE I.
DATA: AMAKTX11      TYPE MAKT-MAKTX,
      AMAKTX12      TYPE MAKT-MAKTX,
      ANORMT1       TYPE MARA-NORMT,
      AMAKTX13(100) TYPE C,
      AMATNR11      TYPE MARA-MATNR.

DATA: MAKTX1       TYPE MAKT-MAKTX,
      MAKTX2       TYPE MAKT-MAKTX,
      NORMT        TYPE MARA-NORMT,
      MAKTX(100)   TYPE C,
      MAKTX4(150)  TYPE C,
      MQTY1(10)    TYPE C,
      AMAKTX1      TYPE MAKT-MAKTX,
      AMAKTX2      TYPE MAKT-MAKTX,
      ANORMT       TYPE MARA-NORMT,
      AMAKTX(100)  TYPE C,
      AMAKTX3(100) TYPE C,
      BMAKTX(100)  TYPE C,
      BMAKTX1(100) TYPE C,
      BMAKTX2(100) TYPE C.

DATA: PADJMENGE TYPE STPO-MENGE.

DATA: AAQTY1(10) TYPE C,
      AAQTY2(10) TYPE C,
      AAQTY3(10) TYPE C.
DATA: ACTTXT1(40) TYPE C,
      ACTTXT2(40) TYPE C,
      ACTTXT3(18) TYPE C.

DATA: COMP TYPE I.
*DATA : TEXT(50) TYPE C.
DATA: CHARG TYPE MCHB-CHARG.
DATA: FGMAKTX TYPE MAKT-MAKTX,
      FGMATNR TYPE MARA-MATNR.
DATA: FGMEINS TYPE  MARA-MEINS.
DATA: COUNT5    TYPE I,
      COUNT6(2) TYPE C,
      PCOUNT(1) TYPE C.
DATA: CED1(1) TYPE C.
DATA: MATNR2TXT(10) TYPE C.
DATA: BATCHS1(20) TYPE C.
DATA: BATCHSIZE(50) TYPE C.
DATA: MSG TYPE STRING.
DATA: LV_ATINN TYPE ATINN.
DATA: LV_ERFME TYPE ERFME.
**************************
SELECTION-SCREEN BEGIN OF BLOCK MERKMALE1 WITH FRAME TITLE TEXT-001.
  PARAMETERS : R1 RADIOBUTTON GROUP R1.
  PARAMETERS : MATNR LIKE MARA-MATNR,
               BATCH LIKE MCHB-CHARG,
               PLANT LIKE MCHB-WERKS.
*PARAMETERS : TEXT(50) TYPE C.
*PARAMETERS : BMENGE LIKE STKO-BMENG.
  PARAMETERS : BOM LIKE MAST-STLAL DEFAULT '01'.
  PARAMETERS : FIFO AS CHECKBOX.
  PARAMETERS : FMATNR1 LIKE MARA-MATNR,
               FMATNR2 LIKE MARA-MATNR,
               FMATNR3 LIKE MARA-MATNR,
               FMATNR4 LIKE MARA-MATNR,
               FMATNR5 LIKE MARA-MATNR,
               FMATNR6 LIKE MARA-MATNR.
  PARAMETERS : R2 RADIOBUTTON GROUP R1.
*SELECT-OPTIONS: BMATNR FOR MARA-MATNR.
*PARAMETERS : BWERKS LIKE MCHB-WERKS.


SELECTION-SCREEN END OF BLOCK MERKMALE1 .

INITIALIZATION.
  G_REPID = SY-REPID.

AT SELECTION-SCREEN.
  PERFORM AUTHORIZATION.

START-OF-SELECTION.



  IF PLANT IS INITIAL.
    MESSAGE 'ENTER PLANT CODE FOR POTENCY SHEET' TYPE 'E'.
  ENDIF.

  IF MATNR IS INITIAL.
    MESSAGE 'ENTER HALB CODE FOR POTENCY SHEET' TYPE 'E'.
  ENDIF.

  IF BOM IS INITIAL.
    MESSAGE 'ENTER BOM NO. FOR POTENCY SHEET' TYPE 'E'.
  ENDIF.


  IF R2 EQ 'X'.
*    IF BWERKS IS INITIAL.
*      MESSAGE 'ENTER PLANT CODE TO DISPLAY ACTIVE BOM' TYPE 'E'.
*    ENDIF.
    PERFORM ACTIVEBOM.
  ELSEIF R1 EQ 'X'.


    PERFORM INACTIVEBOM.


    SELECT SINGLE * FROM ZPOTENCY_BOM1 WHERE FGMATNR EQ MATNR.
    IF SY-SUBRC EQ 0.
      PERFORM POTENCYADJ.
    ELSE.
      PERFORM POTENCYF1.
    ENDIF.

  ENDIF.


*IF IT_MAST IS NOT INITIAL.
*  SELECT * FROM STPO INTO TABLE IT_STPO FOR ALL ENTRIES IN IT_MAST WHERE STLTY EQ 'M' AND STLNR EQ IT_MAST-STLNR.
*  IF SY-SUBRC NE 0.
*    MESSAGE 'NO DATA FOUND' TYPE 'E'.
*  ENDIF.
*ENDIF.
*&---------------------------------------------------------------------*
*&      Form  FORM1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FORM1 .
  SELECT SINGLE * FROM MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT SINGLE * FROM STKO WHERE STLNR EQ MAST-STLNR AND STLAL = MAST-STLAL AND LOEKZ EQ SPACE.
    IF SY-SUBRC EQ 0.
*      WRITE : / 'batch size: ',STKO-BMENG.
    ELSE.
      MESSAGE 'THIS BOM IS NOT VALID' TYPE 'E'.
      EXIT.
    ENDIF.
  ENDIF.
*  WRITE : / 'Date',SY-DATUM, 'Time:',SY-UZEIT.
  COMP = 1.
  SELECT SINGLE * FROM MARM WHERE MATNR EQ MATNR AND MEINH IN ('L','KG').
  IF SY-SUBRC EQ 0.
    COMP = 0.
  ENDIF.


  SELECT * FROM MAST INTO TABLE IT_MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAN EQ 1 AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT * FROM STAS INTO TABLE IT_STAS FOR ALL ENTRIES IN IT_MAST WHERE STLNR EQ IT_MAST-STLNR AND STLAL EQ IT_MAST-STLAL.
    IF SY-SUBRC EQ 0.
      SELECT * FROM STPO INTO TABLE IT_STPO FOR ALL ENTRIES IN IT_STAS WHERE STLNR EQ IT_STAS-STLNR AND STLKN EQ IT_STAS-STLKN.
    ENDIF.
  ENDIF.
  SORT IT_STPO BY POSNR.

  LOOP AT IT_MAST INTO WA_MAST.
    CLEAR : WRKST.
    LOOP AT IT_STAS INTO WA_STAS WHERE STLNR = WA_MAST-STLNR AND STLAL = WA_MAST-STLAL.
      LOOP AT IT_STPO INTO WA_STPO WHERE STLNR = WA_STAS-STLNR AND STLKN = WA_STAS-STLKN.
*       AND IDNRK CS 'H'.
*      WRITE : / '1',WA_STPO-IDNRK,WA_STPO-MENGE,WA_STPO-POSNR.
        SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_STPO-IDNRK AND MATKL IN ( 'RAG001','RAC001','RAB001' ) .
        IF SY-SUBRC EQ 0.
*        WRITE : COUNT.
          WA_TAB1-MATNR = WA_STPO-IDNRK.
          WA_TAB1-MENGE = WA_STPO-MENGE.
          WA_TAB1-MEINS = WA_STPO-MEINS.
          WA_TAB1-POSNR = WA_STPO-POSNR.
          WA_TAB1-POTX1 = WA_STPO-POTX1.
          CLEAR: MATNR1.
          MATNR1 = WA_STPO-SORTF.
          SHIFT MATNR1 RIGHT DELETING TRAILING SPACE.
          OVERLAY MATNR1 WITH '000000000000000000'.
          WA_TAB1-SORTF = MATNR1.

          COLLECT WA_TAB1 INTO IT_TAB1.
          CLEAR WA_TAB1.
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDLOOP.


  LOOP AT IT_TAB1 INTO WA_TAB1.
    SELECT SINGLE * FROM ZPOTENCY_INC WHERE FGMATNR EQ MATNR AND WERKS EQ PLANT AND STLAL EQ BOM AND IDNRK EQ WA_TAB1-MATNR.
    IF SY-SUBRC EQ 0.
      DELETE IT_TAB1 WHERE MATNR = ZPOTENCY_INC-IDNRK.
    ENDIF.
  ENDLOOP.


  SORT IT_TAB1 BY POSNR.
  CLEAR : COUNT.

  LOOP AT IT_TAB1 INTO WA_TAB1.
    COUNT = COUNT + 1.
*    WRITE: / 'ACTIVE BOM COMPONANT',WA_TAB1-POSNR,WA_TAB1-MATNR,WA_TAB1-MENGE,WA_TAB1-SORTF.
    WA_TAB2-POSNR = WA_TAB1-POSNR.
    WA_TAB2-MATNR = WA_TAB1-MATNR.
    WA_TAB2-MENGE = WA_TAB1-MENGE.
    WA_TAB2-MEINS = WA_TAB1-MEINS.
    WA_TAB2-SORTF = WA_TAB1-SORTF.
    WA_TAB2-POTX1 = WA_TAB1-POTX1.
    WA_TAB2-COUNT = COUNT.
    COLLECT WA_TAB2 INTO IT_TAB2.
    CLEAR WA_TAB2.
  ENDLOOP.


*  LOOP AT IT_TAB2 INTO WA_TAB2.
*    WRITE : / 'b',WA_TAB2-POSNR,WA_TAB2-MATNR,WA_TAB2-MENGE,WA_TAB2-SORTF,WA_TAB2-COUNT.
*  ENDLOOP.

  PERFORM ADJ.
*  LOOP AT IT_ADJ2 INTO WA_ADJ2.
*    WRITE : / 'ADJ*', WA_ADJ2-POSNR,WA_ADJ2-MATNR,WA_ADJ2-MENGE,WA_ADJ2-COUNT.
*  ENDLOOP.

*  LOOP AT IT_TAB2 INTO WA_TAB2.
*    WRITE : / '1',WA_TAB2-POSNR,WA_TAB2-MATNR,WA_TAB2-MENGE,WA_TAB2-SORTF,WA_TAB2-COUNT.
*    READ TABLE IT_ADJ2 INTO WA_ADJ2 WITH KEY MATNR = WA_TAB2-SORTF COUNT = WA_TAB2-COUNT.
*    IF SY-SUBRC EQ 0.
*      WRITE : 'ADJ',WA_ADJ2-POSNR,WA_ADJ2-MATNR,WA_ADJ2-MENGE.
*    ENDIF.
*  ENDLOOP.

  LOOP AT IT_TAB2 INTO WA_TAB2.
    WA_MAT1-POSNR = WA_TAB2-POSNR.
    WA_MAT1-MATNR = WA_TAB2-MATNR.
    WA_MAT1-MENGE = WA_TAB2-MENGE.
    WA_MAT1-MENGE1 = WA_TAB2-MENGE.
    WA_MAT1-MEINS = WA_TAB2-MEINS.
    WA_MAT1-COUNT = WA_TAB2-COUNT.
    WA_MAT1-POTX1 = WA_TAB2-POTX1.
    READ TABLE IT_ADJ2 INTO WA_ADJ2 WITH KEY MATNR = WA_TAB2-SORTF COUNT = WA_TAB2-COUNT.
    IF SY-SUBRC EQ 0.
      WA_MAT1-ADJPOSNR = WA_ADJ2-POSNR.
      WA_MAT1-ADJMATNR = WA_ADJ2-MATNR.
      WA_MAT1-ADJMENGE = WA_ADJ2-MENGE.
      WA_MAT1-ADJMEINS = WA_ADJ2-MEINS.
    ENDIF.
    COLLECT WA_MAT1 INTO IT_MAT1.
    CLEAR WA_MAT1.
  ENDLOOP.

*  LOOP AT IT_MAT1 INTO WA_MAT1.
*    WRITE: /'ACTIVE', 8 WA_MAT1-POSNR,14 WA_MAT1-MATNR,37 WA_MAT1-MENGE LEFT-JUSTIFIED,47 WA_MAT1-MEINS,
*    57 'ADJUSTMENT',68 WA_MAT1-ADJPOSNR,78 WA_MAT1-ADJMATNR,98 WA_MAT1-ADJMENGE LEFT-JUSTIFIED, 108 WA_MAT1-ADJMEINS,
*    WA_MAT1-COUNT.
*  ENDLOOP.




ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  RESERV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM RESERV .
  LOOP AT IT_MAT1 INTO WA_MAT1.
    WA_STK1-MATNR = WA_MAT1-MATNR.
    COLLECT WA_STK1 INTO IT_STK1.
    CLEAR WA_STK1.
    WA_STK1-MATNR = WA_MAT1-ADJMATNR.
    COLLECT WA_STK1 INTO IT_STK1.
    CLEAR WA_STK1.
  ENDLOOP.

  SORT IT_STK1 BY MATNR.
  DELETE ADJACENT DUPLICATES FROM IT_STK1 COMPARING MATNR.

*  LOOP AT IT_STK1 INTO WA_STK1.
*    WRITE : / 'ACTIVE RAW MATERIAL CODES: ',WA_STK1-MATNR.
*  ENDLOOP.
  IF IT_STK1 IS NOT INITIAL.
    SELECT * FROM MCHB INTO TABLE IT_MCHB FOR ALL ENTRIES IN IT_STK1 WHERE MATNR EQ IT_STK1-MATNR AND WERKS EQ PLANT AND LGORT NE 'CSM'
      AND CLABS GT 0.
  ENDIF.

  IF IT_MCHB IS NOT INITIAL.
    SELECT * FROM RESB INTO TABLE IT_RESB FOR ALL ENTRIES IN IT_MCHB WHERE KZEAR NE 'X' AND XLOEK NE 'X' AND MATNR EQ IT_MCHB-MATNR AND WERKS EQ IT_MCHB-WERKS AND
       LGORT EQ IT_MCHB-LGORT AND CHARG EQ IT_MCHB-CHARG .
*      AND AUFNR NE ORDER .
  ENDIF.

  LOOP AT IT_MCHB INTO WA_MCHB.
    LOOP AT IT_RESB INTO WA_RESB WHERE MATNR = WA_MCHB-MATNR AND WERKS = WA_MCHB-WERKS AND LGORT = WA_MCHB-LGORT AND CHARG = WA_MCHB-CHARG.
      IF WA_RESB-BDMNG GE WA_MCHB-CLABS.
        DELETE IT_MCHB WHERE MATNR = WA_RESB-MATNR AND LGORT = WA_RESB-LGORT AND CHARG = WA_RESB-CHARG.
      ELSE.
        CLEAR : CLABS.
        CLABS = WA_MCHB-CLABS - WA_RESB-BDMNG.
        WA_MCHB-CLABS = CLABS.
        MODIFY IT_MCHB FROM WA_MCHB TRANSPORTING CLABS WHERE MATNR = WA_MCHB-MATNR AND WERKS = WA_MCHB-WERKS AND LGORT = WA_MCHB-LGORT AND CHARG = WA_MCHB-CHARG.
      ENDIF.
    ENDLOOP.
  ENDLOOP.

*  LOOP AT IT_MCHB INTO WA_MCHB.
*    WRITE : / 'CURRENT STOCK',WA_MCHB-MATNR,WA_MCHB-WERKS,WA_MCHB-CHARG,WA_MCHB-LGORT,WA_MCHB-CLABS.
*  ENDLOOP.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  STOCK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM STOCK .
*  IF IT_TAB3 IS NOT INITIAL.
  SORT IT_MCHB BY MATNR WERKS CHARG.
  DELETE IT_MCHB WHERE CLABS EQ 0.
  IF IT_MCHB IS NOT INITIAL.
    SELECT * FROM QALS INTO TABLE IT_QALS FOR ALL ENTRIES IN IT_MCHB WHERE MATNR EQ IT_MCHB-MATNR AND WERK EQ IT_MCHB-WERKS AND CHARG EQ IT_MCHB-CHARG.
  ENDIF.

  SORT IT_QALS DESCENDING BY ENSTEHDAT.

  LOOP AT IT_QALS INTO WA_QALS.
    SELECT SINGLE * FROM JEST WHERE OBJNR EQ WA_QALS-OBJNR AND STAT EQ 'I0224'.
    IF SY-SUBRC EQ 0.
      DELETE IT_QALS WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    ENDIF.
  ENDLOOP.
*  FORMAT COLOR 2.

  LOOP AT IT_MCHB INTO WA_MCHB.
    WA_ZMCHB-MATNR = WA_MCHB-MATNR.
    WA_ZMCHB-WERKS = WA_MCHB-WERKS.
    WA_ZMCHB-LGORT = WA_MCHB-LGORT.
    WA_ZMCHB-CHARG = WA_MCHB-CHARG.
    WA_ZMCHB-CLABS = WA_MCHB-CLABS.
    SELECT SINGLE * FROM MCHA WHERE MATNR EQ WA_MCHB-MATNR AND WERKS EQ WA_MCHB-WERKS AND CHARG EQ WA_MCHB-CHARG.
    IF SY-SUBRC EQ 0.
      IF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR1.  "FOLLOW FIFO in insue-material exist.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR2.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR3.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR4.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR5.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR6.

      ELSE.
        WA_ZMCHB-VFDAT = MCHA-VFDAT.
      ENDIF.
      WA_ZMCHB-LWEDT = MCHA-LWEDT.
    ENDIF.
    COLLECT WA_ZMCHB INTO IT_ZMCHB.
    CLEAR WA_ZMCHB.
  ENDLOOP.
  SORT IT_ZMCHB BY MATNR VFDAT LWEDT.

  LOOP AT IT_MAT1 INTO WA_MAT1.

*    FORMAT COLOR 5.
*    WRITE : / WA_MAT1-MATNR,WA_MAT1-POTX1.

    CLEAR : MAKTX1,MAKTX2,MAKTX,NORMT.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX1 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX2 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      NORMT = MARA-NORMT.
    ENDIF.
    CONCATENATE MAKTX1 MAKTX2 NORMT INTO MAKTX SEPARATED BY SPACE.
    CONDENSE MAKTX.
*    WRITE : / 'Potency calculation for',MAKTX.
    CLEAR : MAKTX4,MQTY1.
    MQTY1 = WA_MAT1-MENGE.
    CONDENSE MQTY1.
*    CONCATENATE 'Theoritical qty of ' MAKTX 'per lot = ' MQTY1 WA_MAT1-MEINS 'as 100% on as such basis' INTO MAKTX4
    CONCATENATE 'THEORITICAL QTY OF ' MAKTX 'PER LOT = ' MQTY1 WA_MAT1-MEINS INTO MAKTX4  SEPARATED BY SPACE.
*    'AS 100% ON ' TEXT


*    WRITE : / MAKTX4.
    TQTY1 = 0.
    TQTY2 = 0.
    CLEAR : STOCK.
*    STOCK = WA_MAT1-MENGE.
    STOCK = WA_MAT1-MENGE1.
*    FORMAT COLOR 3.
    CLEAR : STOCK2.
*    WRITE : /1 'BATCH',15 'AVAILABLE QTY', 30 'INSPECTION LOT', 50 'POTENCY', 60 'QTY AS PER ASSAY'.
*    ,80 'DISPENSED QTY'.
*    BREAK-POINT .
    LOOP AT IT_ZMCHB INTO WA_ZMCHB WHERE MATNR = WA_MAT1-MATNR.
*      BREAK-POINT .
      WA_POT1-COUNT = WA_MAT1-COUNT.
      WA_POT1-MATNR = WA_MAT1-MATNR.
      WA_POT1-POTX1 = WA_MAT1-POTX1.
******************************************************************************************
      ON CHANGE OF WA_ZMCHB-MATNR.
*        break-point.
        CLEAR : NPOT1,NPOT2,S3,NSTOCK1.
        READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
        IF SY-SUBRC EQ 0.
          SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
          IF SY-SUBRC EQ 0.
            NPOT1 = ZINSPPOT-UPOT.
          ENDIF.
          IF NPOT1 IS INITIAL.
            SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
            IF SY-SUBRC EQ 0.
              SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
              IF SY-SUBRC EQ 0.
                NPOT1 = QAMR-ORIGINAL_INPUT.
              ENDIF.
            ENDIF.
          ENDIF.
        ENDIF.
        CONDENSE NPOT1.
        NPOT2 = NPOT1.
        IF  NPOT2 GT 0 AND NPOT2 LT 100.
          NSTOCK1 = ( STOCK * 100 ) / NPOT2.
          IF NSTOCK1 GT WA_ZMCHB-CLABS AND STOCK LT WA_ZMCHB-CLABS.  "23.7.23
            STOCK = NSTOCK1.
            S3 = 1.
          ENDIF.
        ENDIF.
      ENDON.
**************************************************************************************************
*      FORMAT COLOR 1.
*      WRITE : / 'STOCK',WA_MCHB-CHARG,WA_MCHB-CLABS.
*      IF WA_MCHB-CLABS GE WA_MAT1-MENGE.
      CLEAR NSTOCK3.
*      nstock3 = stock.
      IF  NPOT2 GT 0.                               "Added by Vinayak S. to avoid divide by 0 dump
        NSTOCK3 = ( STOCK * 100 ) / NPOT2.
      ENDIF.
*      IF WA_ZMCHB-CLABS GE STOCK.
      IF WA_ZMCHB-CLABS GE NSTOCK3.
*        WRITE : / WA_MCHB-CHARG,15 STOCK LEFT-JUSTIFIED.
        WA_POT1-CHARG = WA_ZMCHB-CHARG.
        WA_POT1-STOCK = STOCK.
        CLEAR : STOCK1.
        STOCK1 = STOCK.
        CLEAR : S1.
        S1 = 'L'.
        PERFORM POTENCY.
*        WA_MCHB-CLABS = WA_MCHB-CLABS - WA_MAT1-MENGE.
        WA_ZMCHB-CLABS = WA_ZMCHB-CLABS - STOCK2.
        MODIFY IT_ZMCHB FROM WA_ZMCHB TRANSPORTING CLABS WHERE MATNR = WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.
        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
        EXIT.
      ELSE.
        STOCK = STOCK - WA_ZMCHB-CLABS.
*        WRITE : /1 WA_MCHB-CHARG,15 WA_MCHB-CLABS LEFT-JUSTIFIED.
        WA_POT1-CHARG = WA_ZMCHB-CHARG.
        WA_POT1-STOCK = WA_ZMCHB-CLABS.
        CLEAR : STOCK1.
        STOCK1 = WA_ZMCHB-CLABS.
        CLEAR : S1.
        PERFORM POTENCY.
        IF THREED EQ 1.
          WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY1.
        ELSE.
          WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY.
        ENDIF.
*        STOCK = STOCK + RQTY.
        IF S3 NE 1.
          IF THREED EQ 1.
            STOCK = STOCK + RQTY1 - CQTY1.
          ELSE.
            STOCK = STOCK + RQTY - CQTY1.
          ENDIF.
*          STOCK = STOCK + RQTY - CQTY1.
        ENDIF.
        MODIFY IT_MAT1 FROM WA_MAT1 TRANSPORTING MENGE WHERE MATNR EQ WA_MCHB-MATNR.
        DELETE IT_ZMCHB WHERE MATNR EQ WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.

        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
      ENDIF.

    ENDLOOP.

*******************************************************************************
    FORMAT COLOR 3.
    CLEAR : ESTOCK.
    ESTOCK = STOCK2 - WA_MAT1-MENGE.
*    WRITE : / 'ACTUAL STOCK',WA_MAT1-MENGE,'dispenced stock',STOCK2,'EXCESS',ESTOCK.
*    WRITE : / 'DISPENCED STOCK: ',STOCK2 LEFT-JUSTIFIED,'  EXCESS',ESTOCK LEFT-JUSTIFIED.
    WA_POS1-STOCK2 = STOCK2.
    WA_POS1-ESTOCK = ESTOCK.
    WA_POS1-ADJMATNR = WA_MAT1-ADJMATNR.
    WA_POS1-COUNT = WA_MAT1-COUNT.
    FORMAT COLOR 4.
    CLEAR : STOCK.
    ASTOCK = WA_MAT1-ADJMENGE - ESTOCK.
*    SKIP.
    IF COMP EQ 1.
*      FORMAT COLOR 7.
*      WRITE : / 'CALCULATION FOR :'.
      CLEAR : AMAKTX1,AMAKTX2,AMAKTX,ANORMT.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX1 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX2 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        ANORMT = MARA-NORMT.
      ENDIF.
      CONCATENATE AMAKTX1 AMAKTX2 ANORMT INTO AMAKTX SEPARATED BY SPACE.
      CONDENSE AMAKTX.
*      WRITE : AMAKTX.
      WA_POS1-AMAKTX = AMAKTX.

*    WA_MAT1-ADJMATNR,WA_MAT1-ADJMENGE,'NEW STOCK',ASTOCK.
      TQTY1 = 0.
      TQTY2 = 0.
*      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(' WA_MAT1-MEINS ')' INTO BMAKTX SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(kg)' INTO BMAKTX SEPARATED BY SPACE.
      CONDENSE BMAKTX.
      CLEAR : AQTY1.
      AQTY1 = WA_MAT1-MENGE1 + WA_MAT1-ADJMENGE.
      CLEAR : BMAKTX1.
*      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(' WA_MAT1-MEINS ')' INTO BMAKTX1 SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(kg)' INTO BMAKTX1 SEPARATED BY SPACE.
      CONDENSE BMAKTX1.
      CLEAR : BMAKTX2.
*      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(' WA_MAT1-ADJMEINS ')' INTO BMAKTX2 SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(kg)' INTO BMAKTX2 SEPARATED BY SPACE.
      CONDENSE BMAKTX2.
      CLEAR : ADJQTY,ADJQTY1.
      IF THREED EQ 1.
        ADJQTY1 =  AQTY1 - STOCK2.
        ADJQTY =  AQTY1 - STOCK2.
      ELSE.
        ADJQTY =  AQTY1 - STOCK2.
      ENDIF.
*      WRITE : / BMAKTX, 60 BMAKTX1,120 BMAKTX2.
*      WRITE : / AQTY1, 60 STOCK2,120 ADJQTY.
      WA_POS1-BMAKTX = BMAKTX.
      WA_POS1-BMAKTX1 = BMAKTX1.
      WA_POS1-BMAKTX2 = BMAKTX2.

      WA_POS1-AQTY1 = AQTY1.

      WA_POS1-STOCK2 = STOCK2.
      IF THREED EQ 1.
        WA_POS1-ADJQTY = ADJQTY1.
      ELSE.
        WA_POS1-ADJQTY = ADJQTY.
      ENDIF.
*      ULINE.
*      SKIP.
    ENDIF.
    COLLECT WA_POS1 INTO IT_POS1.
    CLEAR WA_POS1.
  ENDLOOP.
*  ULINE.
*  LOOP AT IT_MCHB INTO WA_MCHB.
*    WRITE : / 'CUR  STOCK',WA_MCHB-MATNR,WA_MCHB-CHARG,WA_MCHB-CLABS.
*  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  POTENCY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM POTENCY.



  READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
  IF SY-SUBRC EQ 0.
*    WRITE : 30  WA_QALS-PRUEFLOS.
    IF WA_QALS-ART = '01'.                    "Added by Vinayak S.
      WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
    ENDIF.
    CLEAR : P1,P2,P3.
    SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    IF SY-SUBRC EQ 0.
      P3 = ZINSPPOT-UPOT.
*      TEXT = ZINSPPOT-SGTXT.
      WA_POT1-P3 = P3.
      CONDENSE WA_POT1-P3.
*      WA_POT1-TEXT = TEXT.
    ENDIF.
    IF P3 LE 0.
      CLEAR : PVAL1.
      SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
      IF SY-SUBRC EQ 0.
        SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
        IF SY-SUBRC EQ 0.
          PVAL1 = QAMR-ORIGINAL_INPUT.
          CONDENSE PVAL1.
          P3 = PVAL1.
        ENDIF.
      ENDIF.
      WA_POT1-P3 = P3.
      CONDENSE WA_POT1-P3.
    ENDIF.
    PERFORM POT1.
  ENDIF.
*  SKIP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  POT1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM POT1 .
  CLEAR : THREED.
  SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_ZMCHB-MATNR.
  IF SY-SUBRC EQ 0.
    THREED = 1.  "for 3 decimal.
    PERFORM POT11.
  ELSE.
    PERFORM POT12.
  ENDIF.

*  CLEAR : QTY1.
*  CLEAR : NQTY1.
***************cedon*****************
*  CLEAR : CED.
*  IF MATNR EQ 'H15107' OR MATNR EQ 'H15108' OR MATNR EQ 'H15106'.
*
*    CED = 73206 / 1000.
*
*    IF S1 EQ 'L'.  "LAST CALCULATION
**    QTY1 = STOCK1 * ( 100 / P3 ).
*      IF P3 GT 0.
**      QTY1 = TQTY2 * ( 100 / P3 ).
*        QTY1 = STOCK1 * ( CED / P3 ).
*      ENDIF.
*    ELSE.
*      QTY1 = STOCK1 * ( P3 / CED ).
*    ENDIF.
*    IF QTY1 GT STOCK1.
*      IF S1 NE 'L'.
*        QTY1 = STOCK1.
*      ENDIF.
*    ENDIF.
*
*    NQTY1 = STOCK1 * ( P3 / CED ).
*    CLEAR : CQTY1.
*    IF NQTY1 GT STOCK1.
*      CQTY1 = NQTY1 - STOCK1.
*    ENDIF.
*    WA_POT1-QTY1 = QTY1.
*    IF S1 EQ 'L'.
*      STOCK2 = STOCK2 + QTY1.
*    ELSE.
*      STOCK2 = STOCK2 + STOCK1.
*    ENDIF.
*    CLEAR : RQTY.
*    RQTY = WA_POT1-STOCK - QTY1.
**    IF WA_POT1-STOCK GT QTY1.
**      WA_POT1-DQTY = WA_POT1-STOCK .
**    ELSE.
*    WA_POT1-DQTY = QTY1.
**    ENDIF.
*
*  ELSE.
*    IF S1 EQ 'L'.
**    QTY1 = STOCK1 * ( 100 / P3 ).
*      IF P3 GT 0.
**      QTY1 = TQTY2 * ( 100 / P3 ).
*        QTY1 = STOCK1 * ( 100 / P3 ).
*      ENDIF.
*    ELSE.
*      QTY1 = STOCK1 * ( P3 / 100 ).
*    ENDIF.
*    IF QTY1 GT STOCK1.
*      IF S1 NE 'L'.
*        QTY1 = STOCK1.
*      ENDIF.
*    ENDIF.
*    NQTY1 = STOCK1 * ( P3 / 100 ).
*
*    IF NQTY1 GT STOCK1.
*      NQTY1 = STOCK1.
*    ENDIF.
*    WA_POT1-QTY1 = QTY1.
*    IF S1 EQ 'L'.
*      STOCK2 = STOCK2 + QTY1.
*    ELSE.
*      STOCK2 = STOCK2 + STOCK1.
*    ENDIF.
*    CLEAR : RQTY.
*    RQTY = WA_POT1-STOCK - QTY1.
*    IF WA_POT1-STOCK  GT QTY1.
*      WA_POT1-DQTY = WA_POT1-STOCK .
*    ELSE.
*      WA_POT1-DQTY = QTY1.
*    ENDIF.
*  ENDIF.
*
**************************************
*
*
*
*
*  WA_POT1-NQTY1 = NQTY1.
*
*
*  TQTY1 = TQTY1 + QTY1.
**  P3 = P1 - P2.
**  WRITE :  p3 .

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ADJ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ADJ .
  LOOP AT IT_MAST INTO WA_MAST.
    CLEAR : WRKST.
    LOOP AT IT_STAS INTO WA_STAS WHERE STLNR = WA_MAST-STLNR AND STLAL = WA_MAST-STLAL.
      LOOP AT IT_STPO INTO WA_STPO WHERE STLNR = WA_STAS-STLNR AND STLKN = WA_STAS-STLKN AND SORTF NE SPACE.
        READ TABLE IT_TAB2 INTO WA_TAB2 WITH KEY SORTF = WA_STPO-IDNRK.
        IF SY-SUBRC EQ 0.
*       AND IDNRK CS 'H'.
*          WRITE : / 'ADJ',WA_STPO-IDNRK,WA_STPO-MENGE,WA_STPO-POSNR.
          WA_ADJ1-MATNR = WA_STPO-IDNRK.
          WA_ADJ1-MENGE = WA_STPO-MENGE.
          WA_ADJ1-MEINS = WA_STPO-MEINS.
          WA_ADJ1-POSNR = WA_STPO-POSNR.
          COLLECT WA_ADJ1 INTO IT_ADJ1.
          CLEAR WA_ADJ1.
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDLOOP.

  SORT IT_ADJ1 BY POSNR.
  CLEAR : COUNT.
  LOOP AT IT_ADJ1 INTO WA_ADJ1.
    COUNT = COUNT + 1.
    WA_ADJ2-MATNR = WA_ADJ1-MATNR.
    WA_ADJ2-MENGE = WA_ADJ1-MENGE.
    WA_ADJ2-MEINS = WA_ADJ1-MEINS.
    WA_ADJ2-POSNR = WA_ADJ1-POSNR.
    WA_ADJ2-COUNT = COUNT.
    COLLECT WA_ADJ2 INTO IT_ADJ2.
    CLEAR WA_ADJ2.
  ENDLOOP.

*  LOOP AT IT_ADJ2 INTO WA_ADJ2.
*    WRITE : / 'ADJ*', WA_ADJ2-POSNR,WA_ADJ2-MATNR,WA_ADJ2-MENGE,WA_ADJ2-COUNT.
*  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  PRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM PRINT .



  CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
    EXPORTING
*     FORMNAME           = 'ZPOTENCY7'  "12.4.21
*     FORMNAME           = 'ZPOTENCY_1'  "12.4.21
*     FORMNAME           = 'ZPOTENCY_2'  "12.4.21
      FORMNAME           = 'ZPOTENCY_4'  "12.4.21
*     FORMNAME           = 'ZPOTENCY_3'  "12.4.21
*     FORMNAME           = 'ZPOTENCY4'  "12.4.21
*     VARIANT            = ' '
*     DIRECT_CALL        = ' '
    IMPORTING
      FM_NAME            = V_FM
    EXCEPTIONS
      NO_FORM            = 1
      NO_FUNCTION_MODULE = 2
      OTHERS             = 3.

  CONTROL-NO_OPEN   = 'X'.
  CONTROL-NO_CLOSE  = 'X'.

  CALL FUNCTION 'SSF_OPEN'
    EXPORTING
      CONTROL_PARAMETERS = CONTROL.


*  WRITE : / 'AVL QTY',
  CLEAR : ORT01.
  SELECT SINGLE * FROM T001W WHERE WERKS EQ PLANT.
  IF SY-SUBRC EQ 0.
    ORT01 = T001W-ORT01.
  ENDIF.
  CLEAR : COUNT5,COUNT6.
  LOOP AT IT_MAT1 INTO WA_MAT1.
    COUNT5 = COUNT5 + 1.
  ENDLOOP.
  COUNT6 = COUNT5.
  CONDENSE COUNT6.
  CLEAR : PCOUNT.
  IF COUNT5 GT 1.
    PCOUNT = 'A'.
  ENDIF.

  LOOP AT IT_MAT1 INTO WA_MAT1.
    CLEAR : THREED.
    SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      THREED = 1.  "for 3 decimal.
    ENDIF.

    CLEAR : COUNT1.
    COUNT1 = 1.
    CLEAR : POTQTY1,POTQTY2,MENGE1.
    CLEAR : POTQTY31,POTQTY32.
    MENGE1 = WA_MAT1-MENGE1.
*    CONCATENATE '100' text INTO text SEPARATED BY space.
    LOOP AT IT_POT1 INTO WA_POT1 WHERE MATNR = WA_MAT1-MATNR AND COUNT EQ WA_MAT1-COUNT.

*      WRITE : / WA_POT1-MATNR,WA_POT1-CHARG,WA_POT1-PRUEFLOS,WA_POT1-STOCK,WA_POT1-P3,WA_POT1-NQTY1,WA_POT1-DQTY.
*      WA_POT2-MATNR = WA_POT1-MATNR.
      WA_POT2-SR = COUNT1.
      WA_POT2-CHARG = WA_POT1-CHARG.
      WA_POT2-PRUEFLOS = WA_POT1-PRUEFLOS.
      WA_POT2-STOCK = WA_POT1-STOCK.
      WA_POT2-P3 = WA_POT1-P3.
      IF THREED EQ 1.
        WA_POT2-NQTY1 = WA_POT1-NQTY11.
        WA_POT2-DQTY = WA_POT1-DQTY11.
      ELSE.
        WA_POT2-NQTY1 = WA_POT1-NQTY1.
        WA_POT2-DQTY = WA_POT1-DQTY.
      ENDIF.
*BREAK-POINT.
      COLLECT WA_POT2 INTO IT_POT2.
      CLEAR WA_POT2.
      POTQTY1 = POTQTY1 + WA_POT1-NQTY1.
      POTQTY2 = POTQTY2 + WA_POT1-DQTY.
      POTQTY31 = POTQTY31 + WA_POT1-NQTY11.
      POTQTY32 = POTQTY32 + WA_POT1-DQTY11.
      COUNT1 = COUNT1 + 1.
    ENDLOOP.
*    WRITE : /81 POTQTY1, POTQTY2.
    CLEAR : POTQTY11,POTQTY12.
    IF THREED EQ 1.
      POTQTY11 = POTQTY31.
      POTQTY12 = POTQTY32.
    ELSE.
      POTQTY11 = POTQTY1.
      POTQTY12 = POTQTY2.
    ENDIF.

    CONDENSE: POTQTY11,POTQTY12.


*    WRITE : / 'ADJUSTMENT'.
    CLEAR : ADJMENGE.
    LOOP AT  IT_POS1 INTO WA_POS1 WHERE ADJMATNR EQ WA_MAT1-ADJMATNR AND COUNT EQ WA_MAT1-COUNT.
      CLEAR : AMAKTX,BMAKTX,BMAKTX1,BMAKTX2,AAQTY1,AAQTY2,AAQTY3,AMAKTX3.
*      WRITE : / WA_POS1-AMAKTX.
      AMAKTX3 = WA_POS1-AMAKTX.
      ADJMATNR = WA_POS1-ADJMATNR.
      PADJMENGE = WA_MAT1-ADJMENGE.
*      WRITE : / WA_POS1-BMAKTX, WA_POS1-BMAKTX1, WA_POS1-BMAKTX2.
      BMAKTX = WA_POS1-BMAKTX.
      BMAKTX1 = WA_POS1-BMAKTX1.
      BMAKTX2 = WA_POS1-BMAKTX2.
*      WRITE : / '**',WA_POS1-AQTY1, WA_POS1-STOCK2, WA_POS1-ADJQTY.
      AAQTY1 = WA_POS1-AQTY1.
*      aaqty2 = wa_pos1-stock2.
      AAQTY2 = POTQTY12.
*      aaqty3 = wa_pos1-adjqty.
      AAQTY3 = WA_POS1-AQTY1 - POTQTY12.
    ENDLOOP.
    CLEAR : ACTTXT1,ACTTXT2,ACTTXT3.
    SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAT1-MATNR AND SPRAS EQ 'EN'.
    IF SY-SUBRC EQ 0.
      ACTTXT1 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAT1-MATNR AND SPRAS EQ 'Z1'.
    IF SY-SUBRC EQ 0.
      ACTTXT2 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR .
    IF SY-SUBRC EQ 0.
      ACTTXT3 = MARA-NORMT.
    ENDIF.
    CONCATENATE ACTTXT1 ACTTXT2 ACTTXT3 INTO AMAKTX SEPARATED BY SPACE.

    CONDENSE : AAQTY1,AAQTY2,AAQTY3,BMAKTX,BMAKTX1,BMAKTX2.
    CLEAR : MATNR2.
    MATNR2   = WA_MAT1-MATNR.

    PACK MATNR2 TO MATNR2.
    CONDENSE MATNR2.
    CHARG = BATCH.
    CLEAR : CED1.
    IF MATNR2 EQ '100065'.
      CED1 = '2'.
    ELSEIF MATNR2 EQ '100693'.
      CED1 = '4'.
    ELSEIF MATNR2 EQ '100110'.
      CED1 = '5'.
*    ELSEIF matnr EQ 'H15107' OR matnr EQ 'H15108' OR matnr EQ 'H15106'.
    ELSEIF MATNR EQ 'G15107' OR MATNR EQ 'G15108' OR MATNR EQ 'G15106'.
      CED1 = '1'.
    ELSE.
      CED1 = '3'.
    ENDIF.
    CLEAR : MATNR2TXT.
    LOOP AT IT_POT2 INTO WA_POT2.
      SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_POT2-PRUEFLOS AND SGTXT NE SPACE.
      IF SY-SUBRC EQ 0.
        MATNR2TXT = ZINSPPOT-SGTXT.
      ENDIF.
    ENDLOOP.
    CONDENSE MATNR2TXT.

    PERFORM UPDATE_POT2.

    CALL FUNCTION V_FM
      EXPORTING
        CONTROL_PARAMETERS = CONTROL
        USER_SETTINGS      = 'X'
        OUTPUT_OPTIONS     = W_SSFCOMPOP
        FORMAT             = FORMAT
        POTQTY11           = POTQTY11
        POTQTY12           = POTQTY12
        AMAKTX             = AMAKTX
        BMAKTX             = BMAKTX
        BMAKTX1            = BMAKTX1
        BMAKTX2            = BMAKTX2
        AAQTY1             = AAQTY1
        AAQTY2             = AAQTY2
        AAQTY3             = AAQTY3
        MATNR2             = MATNR2
        MENGE1             = MENGE1
*       TEXT               = TEXT
        COUNT              = WA_MAT1-COUNT
        POTX1              = WA_MAT1-POTX1
        ORT01              = ORT01
        MAKTX              = MAKTX
        CHARG              = CHARG
        FGMAKTX            = FGMAKTX
        FGMATNR            = FGMATNR
        AMAKTX3            = AMAKTX3
        FGMEINS            = FGMEINS
        ADJMATNR           = ADJMATNR
        COUNT6             = COUNT6
        CED1               = CED1
        PADJMENGE          = PADJMENGE
        MATNR2TXT          = MATNR2TXT
        BATCHSIZE          = BATCHSIZE
        PCOUNT             = PCOUNT
      TABLES
        IT_POT2            = IT_POT2
      EXCEPTIONS
        FORMATTING_ERROR   = 1
        INTERNAL_ERROR     = 2
        SEND_ERROR         = 3
        USER_CANCELED      = 4
        OTHERS             = 5.

    CLEAR : IT_POT2.
    CLEAR:  FORMAT, POTQTY11, POTQTY12,AMAKTX, BMAKTX, BMAKTX1,BMAKTX2, AAQTY1,AAQTY2,AAQTY3, MATNR2,MENGE1, COUNT,
    MAKTX,AMAKTX3,ADJMATNR,PADJMENGE.
    CLEAR : ADJMATNR.
  ENDLOOP.

  CALL FUNCTION 'SSF_CLOSE'.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  POTENCYF1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM POTENCYF1 .
  SELECT SINGLE * FROM MARA WHERE MATNR EQ MATNR.
  IF SY-SUBRC EQ 0.
    FGMEINS = MARA-MEINS.
  ENDIF.
  IF MARA-MEINS EQ 'KG'.
    FGMEINS = 'L'.
  ENDIF.


  SELECT SINGLE * FROM MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAN EQ '1' AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT SINGLE * FROM STKO WHERE STLNR EQ MAST-STLNR AND STLAL EQ MAST-STLAL AND LOEKZ EQ SPACE.
    IF SY-SUBRC EQ 0.
      CLEAR : BATCHS1.
      BATCHS1 = STKO-BMENG.
      CONDENSE BATCHS1.
      CONCATENATE BATCHS1 STKO-BMEIN INTO BATCHSIZE SEPARATED BY SPACE.
    ENDIF.
  ENDIF.
  CONDENSE BATCHSIZE.

  SELECT SINGLE * FROM MAKT WHERE MATNR EQ MATNR.
  IF SY-SUBRC EQ 0.
*    WRITE : / 'PRODUCT : ',MAKT-MAKTX,
*            / 'CODE : ',MATNR,
*            / 'BATCH: ',BATCH.
    FGMAKTX = MAKT-MAKTX.
    FGMATNR = MATNR.
  ENDIF.
  PERFORM FORM1.
  PERFORM RESERV.
  IF PLANT EQ '1001'.
    PERFORM GOASTOCK.
  ELSE.
    PERFORM STOCK.
  ENDIF.
  PERFORM PRINT.



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  POTENCYADJ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM POTENCYADJ .
  SELECT SINGLE * FROM MARA WHERE MATNR EQ MATNR.
  IF SY-SUBRC EQ 0.
    FGMEINS = MARA-MEINS.
  ENDIF.
  IF MARA-MEINS EQ 'KG'.
    FGMEINS = 'L'.
  ENDIF.
  SELECT SINGLE * FROM MAKT WHERE MATNR EQ MATNR.
  IF SY-SUBRC EQ 0.
*    WRITE : / 'PRODUCT : ',MAKT-MAKTX,
*            / 'CODE : ',MATNR,
*            / 'BATCH: ',BATCH.
    FGMAKTX = MAKT-MAKTX.
    FGMATNR = MATNR.
  ENDIF.

  SELECT SINGLE * FROM MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAN EQ '1' AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT SINGLE * FROM STKO WHERE STLNR EQ MAST-STLNR AND STLAL EQ MAST-STLAL AND LOEKZ EQ SPACE.
    IF SY-SUBRC EQ 0.
      CLEAR : BATCHS1.
      BATCHS1 = STKO-BMENG.
      CONDENSE BATCHS1.
      CONCATENATE BATCHS1 STKO-BMEIN INTO BATCHSIZE SEPARATED BY SPACE.
    ENDIF.
  ENDIF.
  CONDENSE BATCHSIZE.

  PERFORM AFORM1.
  PERFORM ARESERV.
  IF PLANT EQ '1001'.
    PERFORM ASTOCK_G.
  ELSE.
    PERFORM ASTOCK.
  ENDIF.
  PERFORM APRINT.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  AFORM1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM AFORM1 .
  SELECT SINGLE * FROM MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT SINGLE * FROM STKO WHERE STLNR EQ MAST-STLNR AND STLAL = MAST-STLAL AND LOEKZ EQ SPACE.
    IF SY-SUBRC EQ 0.
*      WRITE : / 'batch size: ',STKO-BMENG.
    ELSE.
      MESSAGE 'THIS BOM IS NOT VALID' TYPE 'E'.
      EXIT.
    ENDIF.
  ENDIF.
*  WRITE : / 'Date',SY-DATUM, 'Time:',SY-UZEIT.
  COMP = 1.
  SELECT SINGLE * FROM MARM WHERE MATNR EQ MATNR AND MEINH IN ('L','KG').
  IF SY-SUBRC EQ 0.
    COMP = 0.
  ENDIF.


  SELECT * FROM MAST INTO TABLE IT_MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAN EQ 1 AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT * FROM STAS INTO TABLE IT_STAS FOR ALL ENTRIES IN IT_MAST WHERE STLNR EQ IT_MAST-STLNR AND STLAL EQ IT_MAST-STLAL.
    IF SY-SUBRC EQ 0.
      SELECT * FROM STPO INTO TABLE IT_STPO FOR ALL ENTRIES IN IT_STAS WHERE STLNR EQ IT_STAS-STLNR AND STLKN EQ IT_STAS-STLKN.
    ENDIF.
  ENDIF.
  SORT IT_STPO BY POSNR.

  LOOP AT IT_MAST INTO WA_MAST.
    CLEAR : WRKST.
    LOOP AT IT_STAS INTO WA_STAS WHERE STLNR = WA_MAST-STLNR AND STLAL = WA_MAST-STLAL.
      LOOP AT IT_STPO INTO WA_STPO WHERE STLNR = WA_STAS-STLNR AND STLKN = WA_STAS-STLKN.
*       AND IDNRK CS 'H'.
*      WRITE : / '1',WA_STPO-IDNRK,WA_STPO-MENGE,WA_STPO-POSNR.
        SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_STPO-IDNRK AND MATKL IN ( 'RAG001','RAC001','RAB001' ) .
        IF SY-SUBRC EQ 0.
*        WRITE : COUNT.
          WA_TAB1-MATNR = WA_STPO-IDNRK.
          WA_TAB1-MENGE = WA_STPO-MENGE.
          WA_TAB1-MEINS = WA_STPO-MEINS.
          WA_TAB1-POSNR = WA_STPO-POSNR.
          WA_TAB1-POTX1 = WA_STPO-POTX1.
          CLEAR: MATNR1.
          MATNR1 = WA_STPO-SORTF.
          SHIFT MATNR1 RIGHT DELETING TRAILING SPACE.
          OVERLAY MATNR1 WITH '000000000000000000'.
          WA_TAB1-SORTF = MATNR1.

          COLLECT WA_TAB1 INTO IT_TAB1.
          CLEAR WA_TAB1.
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDLOOP.

  LOOP AT IT_TAB1 INTO WA_TAB1.
    SELECT SINGLE * FROM ZPOTENCY_INC WHERE FGMATNR EQ MATNR AND WERKS EQ PLANT AND STLAL EQ BOM AND IDNRK EQ WA_TAB1-MATNR.
    IF SY-SUBRC EQ 0.
      DELETE IT_TAB1 WHERE MATNR = ZPOTENCY_INC-IDNRK.
    ENDIF.
  ENDLOOP.

  SORT IT_TAB1 BY POSNR.
  CLEAR : COUNT.

  LOOP AT IT_TAB1 INTO WA_TAB1.
    COUNT = COUNT + 1.
*    WRITE: / 'ACTIVE BOM COMPONANT',WA_TAB1-POSNR,WA_TAB1-MATNR,WA_TAB1-MENGE,WA_TAB1-SORTF.
    WA_TAB2-POSNR = WA_TAB1-POSNR.
    WA_TAB2-MATNR = WA_TAB1-MATNR.
    WA_TAB2-MENGE = WA_TAB1-MENGE.
    WA_TAB2-MEINS = WA_TAB1-MEINS.
    WA_TAB2-SORTF = WA_TAB1-SORTF.
    WA_TAB2-POTX1 = WA_TAB1-POTX1.
    WA_TAB2-COUNT = COUNT.
    COLLECT WA_TAB2 INTO IT_TAB2.
    CLEAR WA_TAB2.
  ENDLOOP.


*  LOOP AT IT_TAB2 INTO WA_TAB2.
*    WRITE : / 'b',WA_TAB2-POSNR,WA_TAB2-MATNR,WA_TAB2-MENGE,WA_TAB2-SORTF,WA_TAB2-COUNT.
*  ENDLOOP.

  PERFORM AADJ.
*  LOOP AT IT_ADJ2 INTO WA_ADJ2.
*    WRITE : / 'ADJ*', WA_ADJ2-POSNR,WA_ADJ2-MATNR,WA_ADJ2-MENGE,WA_ADJ2-COUNT.
*  ENDLOOP.

*  LOOP AT IT_TAB2 INTO WA_TAB2.
*    WRITE : / '1',WA_TAB2-POSNR,WA_TAB2-MATNR,WA_TAB2-MENGE,WA_TAB2-SORTF,WA_TAB2-COUNT.
*    READ TABLE IT_ADJ2 INTO WA_ADJ2 WITH KEY MATNR = WA_TAB2-SORTF COUNT = WA_TAB2-COUNT.
*    IF SY-SUBRC EQ 0.
*      WRITE : 'ADJ',WA_ADJ2-POSNR,WA_ADJ2-MATNR,WA_ADJ2-MENGE.
*    ENDIF.
*  ENDLOOP.

  LOOP AT IT_TAB2 INTO WA_TAB2.
    WA_MAT1-POSNR = WA_TAB2-POSNR.
    WA_MAT1-MATNR = WA_TAB2-MATNR.
    WA_MAT1-MENGE = WA_TAB2-MENGE.
    WA_MAT1-MENGE1 = WA_TAB2-MENGE.
    WA_MAT1-MEINS = WA_TAB2-MEINS.
    WA_MAT1-COUNT = WA_TAB2-COUNT.
    WA_MAT1-POTX1 = WA_TAB2-POTX1.
    READ TABLE IT_ADJ2 INTO WA_ADJ2 WITH KEY MATNR = WA_TAB2-SORTF COUNT = WA_TAB2-COUNT.
    IF SY-SUBRC EQ 0.
      WA_MAT1-ADJPOSNR = WA_ADJ2-POSNR.
      WA_MAT1-ADJMATNR = WA_ADJ2-MATNR.
      WA_MAT1-ADJMENGE = WA_ADJ2-MENGE.
      WA_MAT1-ADJMEINS = WA_ADJ2-MEINS.
    ENDIF.
    COLLECT WA_MAT1 INTO IT_MAT1.
    CLEAR WA_MAT1.
  ENDLOOP.

*  LOOP AT IT_MAT1 INTO WA_MAT1.
*    WRITE: /'ACTIVE', 8 WA_MAT1-POSNR,14 WA_MAT1-MATNR,37 WA_MAT1-MENGE LEFT-JUSTIFIED,47 WA_MAT1-MEINS,
*    57 'ADJUSTMENT',68 WA_MAT1-ADJPOSNR,78 WA_MAT1-ADJMATNR,98 WA_MAT1-ADJMENGE LEFT-JUSTIFIED, 108 WA_MAT1-ADJMEINS,
*    WA_MAT1-COUNT.
*  ENDLOOP.




ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ARESERV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ARESERV .
  LOOP AT IT_MAT1 INTO WA_MAT1.
    WA_STK1-MATNR = WA_MAT1-MATNR.
    COLLECT WA_STK1 INTO IT_STK1.
    CLEAR WA_STK1.
    WA_STK1-MATNR = WA_MAT1-ADJMATNR.
    COLLECT WA_STK1 INTO IT_STK1.
    CLEAR WA_STK1.
  ENDLOOP.

  SORT IT_STK1 BY MATNR.
  DELETE ADJACENT DUPLICATES FROM IT_STK1 COMPARING MATNR.

*  LOOP AT IT_STK1 INTO WA_STK1.
*    WRITE : / 'ACTIVE RAW MATERIAL CODES: ',WA_STK1-MATNR.
*  ENDLOOP.
  IF IT_STK1 IS NOT INITIAL.
    SELECT * FROM MCHB INTO TABLE IT_MCHB FOR ALL ENTRIES IN IT_STK1 WHERE MATNR EQ IT_STK1-MATNR AND WERKS EQ PLANT AND LGORT NE 'CSM'
      AND CLABS GT 0.
  ENDIF.

  IF IT_MCHB IS NOT INITIAL.
    SELECT * FROM RESB INTO TABLE IT_RESB FOR ALL ENTRIES IN IT_MCHB WHERE KZEAR NE 'X' AND XLOEK NE 'X' AND MATNR EQ IT_MCHB-MATNR AND WERKS EQ IT_MCHB-WERKS AND
       LGORT EQ IT_MCHB-LGORT AND CHARG EQ IT_MCHB-CHARG .
*      AND AUFNR NE ORDER .
  ENDIF.

  LOOP AT IT_MCHB INTO WA_MCHB.
    LOOP AT IT_RESB INTO WA_RESB WHERE MATNR = WA_MCHB-MATNR AND WERKS = WA_MCHB-WERKS AND LGORT = WA_MCHB-LGORT AND CHARG = WA_MCHB-CHARG.
      IF WA_RESB-BDMNG GE WA_MCHB-CLABS.
        DELETE IT_MCHB WHERE MATNR = WA_RESB-MATNR AND LGORT = WA_RESB-LGORT AND CHARG = WA_RESB-CHARG.
      ELSE.
        CLEAR : CLABS.
        CLABS = WA_MCHB-CLABS - WA_RESB-BDMNG.
        WA_MCHB-CLABS = CLABS.
        MODIFY IT_MCHB FROM WA_MCHB TRANSPORTING CLABS WHERE MATNR = WA_MCHB-MATNR AND WERKS = WA_MCHB-WERKS AND LGORT = WA_MCHB-LGORT AND CHARG = WA_MCHB-CHARG.
      ENDIF.
    ENDLOOP.
  ENDLOOP.

*  LOOP AT IT_MCHB INTO WA_MCHB.
*    WRITE : / 'CURRENT STOCK',WA_MCHB-MATNR,WA_MCHB-WERKS,WA_MCHB-CHARG,WA_MCHB-LGORT,WA_MCHB-CLABS.
*  ENDLOOP.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ASTOCK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ASTOCK .
  SORT IT_MCHB BY MATNR WERKS CHARG.
*  IF IT_TAB3 IS NOT INITIAL.
  DELETE IT_MCHB WHERE CLABS EQ 0.
  IF IT_MCHB IS NOT INITIAL.
    SELECT * FROM QALS INTO TABLE IT_QALS FOR ALL ENTRIES IN IT_MCHB WHERE MATNR EQ IT_MCHB-MATNR AND WERK EQ IT_MCHB-WERKS AND CHARG EQ IT_MCHB-CHARG.
  ENDIF.

  SORT IT_QALS DESCENDING BY ENSTEHDAT.

  LOOP AT IT_QALS INTO WA_QALS.
    SELECT SINGLE * FROM JEST WHERE OBJNR EQ WA_QALS-OBJNR AND STAT EQ 'I0224'.
    IF SY-SUBRC EQ 0.
      DELETE IT_QALS WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    ENDIF.
  ENDLOOP.

  FORMAT COLOR 2.

  LOOP AT IT_MCHB INTO WA_MCHB.
    WA_ZMCHB-MATNR = WA_MCHB-MATNR.
    WA_ZMCHB-WERKS = WA_MCHB-WERKS.
    WA_ZMCHB-LGORT = WA_MCHB-LGORT.
    WA_ZMCHB-CHARG = WA_MCHB-CHARG.
    WA_ZMCHB-CLABS = WA_MCHB-CLABS.
    SELECT SINGLE * FROM MCHA WHERE MATNR EQ WA_MCHB-MATNR AND WERKS EQ WA_MCHB-WERKS AND CHARG EQ WA_MCHB-CHARG.
    IF SY-SUBRC EQ 0.
      IF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR1.  "FOLLOW FIFO in insue-material exist.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR2.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR3.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR4.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR5.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR6.
      ELSE.
        WA_ZMCHB-VFDAT = MCHA-VFDAT.
      ENDIF.
*      WA_ZMCHB-VFDAT = MCHA-VFDAT.
      WA_ZMCHB-LWEDT = MCHA-LWEDT.
    ENDIF.
    COLLECT WA_ZMCHB INTO IT_ZMCHB.
    CLEAR WA_ZMCHB.
  ENDLOOP.
  SORT IT_ZMCHB BY MATNR VFDAT LWEDT.

  LOOP AT IT_MAT1 INTO WA_MAT1.
*    break-point .
*    FORMAT COLOR 5.
*    WRITE : / WA_MAT1-MATNR,WA_MAT1-POTX1.

    CLEAR : MAKTX1,MAKTX2,MAKTX,NORMT.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX1 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX2 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      NORMT = MARA-NORMT.
    ENDIF.
    CONCATENATE MAKTX1 MAKTX2 NORMT INTO MAKTX SEPARATED BY SPACE.
    CONDENSE MAKTX.
*    WRITE : / 'Potency calculation for',MAKTX.
    CLEAR : MAKTX4,MQTY1.
    MQTY1 = WA_MAT1-MENGE.
    CONDENSE MQTY1.
*    CONCATENATE 'Theoritical qty of ' MAKTX 'per lot = ' MQTY1 WA_MAT1-MEINS 'as 100% on as such basis' INTO MAKTX4
*    CONCATENATE 'THEORITICAL QTY OF ' MAKTX 'PER LOT = ' MQTY1 WA_MAT1-MEINS 'AS 100% ON ' TEXT INTO MAKTX4
    CONCATENATE 'THEORITICAL QTY OF ' MAKTX 'PER LOT = ' MQTY1 WA_MAT1-MEINS INTO MAKTX4  SEPARATED BY SPACE.
*    WRITE : / MAKTX4.
    TQTY1 = 0.
    TQTY2 = 0.
    CLEAR : STOCK.
    STOCK = WA_MAT1-MENGE1.
*    FORMAT COLOR 3.
    CLEAR : STOCK2.
*    WRITE : /1 'BATCH',15 'AVAILABLE QTY', 30 'INSPECTION LOT', 50 'POTENCY', 60 'QTY AS PER ASSAY'.
*    ,80 'DISPENSED QTY'.
*    LOOP AT IT_MCHB INTO WA_MCHB WHERE MATNR = WA_MAT1-MATNR.
    LOOP AT IT_ZMCHB INTO WA_ZMCHB WHERE MATNR = WA_MAT1-MATNR.
      WA_POT1-COUNT = WA_MAT1-COUNT.
      WA_POT1-MATNR = WA_MAT1-MATNR.
      WA_POT1-POTX1 = WA_MAT1-POTX1.
*      FORMAT COLOR 1.
*      WRITE : / 'STOCK',WA_MCHB-CHARG,WA_MCHB-CLABS.
*      IF WA_MCHB-CLABS GE WA_MAT1-MENGE.
      ON CHANGE OF WA_ZMCHB-MATNR.
*        break-point.
        CLEAR : NPOT1,NPOT2,S3,NSTOCK1.
        READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
        IF SY-SUBRC EQ 0.
          SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
          IF SY-SUBRC EQ 0.
            NPOT1 = ZINSPPOT-UPOT.
          ENDIF.
          IF NPOT1 IS INITIAL.
            CLEAR : PVAL1.
            SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
            IF SY-SUBRC EQ 0.
              SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
              IF SY-SUBRC EQ 0.
                PVAL1 = QAMR-ORIGINAL_INPUT.
                CONDENSE PVAL1.
                NPOT1 = PVAL1.
              ENDIF.
            ENDIF.
          ENDIF.


        ENDIF.
*        CONDENSE NPOT1.
        NPOT2 = NPOT1.
        IF NPOT2 GT 0 AND NPOT2 LT 100.
          NSTOCK1 = ( STOCK * 100 ) / NPOT2.
          IF NSTOCK1 GT WA_ZMCHB-CLABS AND STOCK LT WA_ZMCHB-CLABS.  "23.7.23
            STOCK = NSTOCK1.
            S3 = 1.
          ENDIF.
        ENDIF.
      ENDON.
*      if wa_mchb-charg eq '0000121058'.
*        stock = 100 + ( 46 / 100 ).
*      endif.
      IF WA_ZMCHB-CLABS GE STOCK.
*        WRITE : / WA_MCHB-CHARG,15 STOCK LEFT-JUSTIFIED.
        WA_POT1-CHARG = WA_ZMCHB-CHARG.
        WA_POT1-STOCK = STOCK.
        CLEAR : STOCK1.
        STOCK1 = STOCK.
        CLEAR : S1.
        S1 = 'L'.
        STOCK2 = 0. "added on 6.1.25
        PERFORM APOTENCY.
*        WA_MCHB-CLABS = WA_MCHB-CLABS - WA_MAT1-MENGE.
        WA_ZMCHB-CLABS = WA_ZMCHB-CLABS - STOCK2.
        MODIFY IT_ZMCHB FROM WA_ZMCHB TRANSPORTING CLABS WHERE MATNR = WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.
        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
        EXIT.
      ELSE.
        STOCK = STOCK - WA_ZMCHB-CLABS.
*        WRITE : /1 WA_MCHB-CHARG,15 WA_MCHB-CLABS LEFT-JUSTIFIED.
        WA_POT1-CHARG = WA_ZMCHB-CHARG.
        WA_POT1-STOCK = WA_ZMCHB-CLABS.
        CLEAR : STOCK1.
        STOCK1 = WA_ZMCHB-CLABS.
        CLEAR : S1.
        PERFORM APOTENCY.
        WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY.
        IF S3 NE 1.
          STOCK = STOCK + RQTY.
        ENDIF.
        MODIFY IT_MAT1 FROM WA_MAT1 TRANSPORTING MENGE WHERE MATNR EQ WA_ZMCHB-MATNR.
        DELETE IT_ZMCHB WHERE MATNR EQ WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.

        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
      ENDIF.

    ENDLOOP.

*******************************************************************************
    FORMAT COLOR 3.
    CLEAR : ESTOCK.
    ESTOCK = STOCK2 - WA_MAT1-MENGE.
*    WRITE : / 'ACTUAL STOCK',WA_MAT1-MENGE,'dispenced stock',STOCK2,'EXCESS',ESTOCK.
*    WRITE : / 'DISPENCED STOCK: ',STOCK2 LEFT-JUSTIFIED,'  EXCESS',ESTOCK LEFT-JUSTIFIED.
    WA_POS1-STOCK2 = STOCK2.
    WA_POS1-ESTOCK = ESTOCK.
    WA_POS1-ADJMATNR = WA_MAT1-ADJMATNR.
    WA_POS1-COUNT = WA_MAT1-COUNT.
    FORMAT COLOR 4.
    CLEAR : STOCK.
    ASTOCK = WA_MAT1-ADJMENGE - ESTOCK.
*    SKIP.
    IF COMP EQ 1.
*      FORMAT COLOR 7.
*      WRITE : / 'CALCULATION FOR :'.
      CLEAR : AMAKTX1,AMAKTX2,AMAKTX,ANORMT.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX1 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX2 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        ANORMT = MARA-NORMT.
      ENDIF.
      CONCATENATE AMAKTX1 AMAKTX2 ANORMT INTO AMAKTX SEPARATED BY SPACE.
      CONDENSE AMAKTX.
*      WRITE : AMAKTX.
      WA_POS1-AMAKTX = AMAKTX.

*    WA_MAT1-ADJMATNR,WA_MAT1-ADJMENGE,'NEW STOCK',ASTOCK.
      TQTY1 = 0.
      TQTY2 = 0.
      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(' WA_MAT1-MEINS ')' INTO BMAKTX SEPARATED BY SPACE.
      CONDENSE BMAKTX.
      CLEAR : AQTY1.
      AQTY1 = WA_MAT1-MENGE1 + WA_MAT1-ADJMENGE.
      CLEAR : BMAKTX1.
      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(' WA_MAT1-MEINS ')' INTO BMAKTX1 SEPARATED BY SPACE.
      CONDENSE BMAKTX1.
      CLEAR : BMAKTX2.
      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(' WA_MAT1-ADJMEINS ')' INTO BMAKTX2 SEPARATED BY SPACE.
      CONDENSE BMAKTX2.
      CLEAR : ADJQTY.
      ADJQTY =  AQTY1 - STOCK2.
*      WRITE : / BMAKTX, 60 BMAKTX1,120 BMAKTX2.
*      WRITE : / AQTY1, 60 STOCK2,120 ADJQTY.
      WA_POS1-BMAKTX = BMAKTX.
      WA_POS1-BMAKTX1 = BMAKTX1.
      WA_POS1-BMAKTX2 = BMAKTX2.
      WA_POS1-AQTY1 = AQTY1.
      WA_POS1-STOCK2 = STOCK2.
      WA_POS1-ADJQTY = ADJQTY.
*      ULINE.
*      SKIP.
    ENDIF.
    COLLECT WA_POS1 INTO IT_POS1.
    CLEAR WA_POS1.
  ENDLOOP.
*  ULINE.
*  LOOP AT IT_MCHB INTO WA_MCHB.
*    WRITE : / 'CUR  STOCK',WA_MCHB-MATNR,WA_MCHB-CHARG,WA_MCHB-CLABS.
*  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APRINT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM APRINT .

*  CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
*    EXPORTING
*      FORMNAME           = 'ZPOTENCY3'  "12.4.21
**     VARIANT            = ' '
**     DIRECT_CALL        = ' '
*    IMPORTING
*      FM_NAME            = V_FM
*    EXCEPTIONS
*      NO_FORM            = 1
*      NO_FUNCTION_MODULE = 2
*      OTHERS             = 3.
*
*  CONTROL-NO_OPEN   = 'X'.
*  CONTROL-NO_CLOSE  = 'X'.
*
*  CALL FUNCTION 'SSF_OPEN'
*    EXPORTING
*      CONTROL_PARAMETERS = CONTROL.

  CALL FUNCTION 'OPEN_FORM'
    EXPORTING
      DEVICE   = 'PRINTER'
      DIALOG   = 'X'
*     form     = 'ZSR9_1'
      LANGUAGE = SY-LANGU
    EXCEPTIONS
      CANCELED = 1
      DEVICE   = 2.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CALL FUNCTION 'START_FORM'
    EXPORTING
*     FORM        = 'ZPOT6'
      FORM        = 'ZPOT72'
*     FORM        = 'ZPOT2'
      LANGUAGE    = SY-LANGU
    EXCEPTIONS
      FORM        = 1
      FORMAT      = 2
      UNENDED     = 3
      UNOPENED    = 4
      UNUSED      = 5
      SPOOL_ERROR = 6
      CODEPAGE    = 7
      OTHERS      = 8.
  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

*  WRITE : / 'AVL QTY',
  CLEAR : ORT01.
  SELECT SINGLE * FROM T001W WHERE WERKS EQ PLANT.
  IF SY-SUBRC EQ 0.
    ORT01 = T001W-ORT01.
  ENDIF.
  BCOUNT1 = 1.

  CLEAR : S2.
  S2 = '1'.

  LOOP AT IT_MAT1 INTO WA_MAT1.
    IF WA_MAT1-MATNR EQ '000000000000100065'.  "no formula
      CLEAR : S2.
    ENDIF.
    CLEAR ADJCNT.
    SELECT SINGLE * FROM ZPOTENCY_BOM1 WHERE FGMATNR EQ FGMATNR AND STLAL EQ BOM AND IDNRK EQ WA_MAT1-MATNR AND MONAT EQ WA_MAT1-COUNT.
    IF SY-SUBRC EQ 0.
      WA_MAT1-ADJMATNR = ZPOTENCY_BOM1-ADJMATNR.
      WA_MAT1-ADJPOSNR = ZPOTENCY_BOM1-ADJPOSNR.
      READ TABLE IT_ADJ2 INTO WA_ADJ2 WITH KEY MATNR = WA_MAT1-ADJMATNR POSNR =  WA_MAT1-ADJPOSNR.
      IF SY-SUBRC EQ 0.
        WA_MAT1-ADJMENGE = WA_ADJ2-MENGE.
        WA_MAT1-ADJMEINS = WA_ADJ2-MEINS.
      ENDIF.
      MODIFY IT_MAT1 FROM WA_MAT1 TRANSPORTING ADJMATNR ADJPOSNR ADJMENGE ADJMEINS.
      CLEAR : WA_MAT1.
    ENDIF.
  ENDLOOP.
  SELECT * FROM ZPOTENCY_BOM1 INTO TABLE IT_ZPOTENCY_BOM1 WHERE FGMATNR EQ FGMATNR AND STLAL EQ BOM.
  COUNT4 = 1.
  PAGE1 = 1.
  LOOP AT IT_MAT1 INTO WA_MAT1.


    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        ELEMENT = 'W1'
        WINDOW  = 'WINDOW1'.

    ON CHANGE OF COUNT4.



      IF PAGE1 GT 1.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            ELEMENT = 'L1'
            WINDOW  = 'MAIN'.
      ELSE.


        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            ELEMENT = 'L2'
            WINDOW  = 'MAIN'.
      ENDIF.
    ENDON.
    FORMAT COLOR 1.
    CLEAR : COUNT1.
    COUNT1 = 1.
    CLEAR : POTQTY1,POTQTY2,POTQTY31,POTQTY32,MENGE1.
    MENGE1 = WA_MAT1-MENGE1.
    TMENGE1 = TMENGE1 + WA_MAT1-MENGE1.
*    CONCATENATE '100' text INTO text SEPARATED BY space.

    CLEAR : AMAKTX11,AMAKTX12,AMAKTX13,ANORMT1,AMATNR11.
    AMATNR11 = WA_MAT1-MATNR.
    PACK AMATNR11 TO AMATNR11.
    CONDENSE AMATNR11.
    SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAT1-MATNR AND SPRAS EQ 'EN'.
    IF SY-SUBRC EQ 0.
      AMAKTX11 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAT1-MATNR AND SPRAS EQ 'Z1'.
    IF SY-SUBRC EQ 0.
      AMAKTX12 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      ANORMT1 = MARA-NORMT.
    ENDIF.
    CONCATENATE AMAKTX11 AMAKTX12 ANORMT1 INTO AMAKTX13 SEPARATED BY SPACE.
    CALL FUNCTION 'WRITE_FORM'
      EXPORTING
        ELEMENT = 'T0'
        WINDOW  = 'MAIN'.

    LOOP AT IT_POT1 INTO WA_POT1 WHERE MATNR = WA_MAT1-MATNR AND COUNT EQ WA_MAT1-COUNT.
      CLEAR : THREED.
      SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_MAT1-MATNR.
      IF SY-SUBRC EQ 0.
        THREED = 1.  "for 3 decimal.
      ENDIF.
*      WRITE : / WA_POT1-MATNR,WA_POT1-CHARG,WA_POT1-PRUEFLOS,WA_POT1-STOCK,WA_POT1-P3,WA_POT1-NQTY1,WA_POT1-DQTY.
*      WA_POT2-MATNR = WA_POT1-MATNR.
      WA_POT2-SR = COUNT1.
      WA_POT2-CHARG = WA_POT1-CHARG.
      WA_POT2-PRUEFLOS = WA_POT1-PRUEFLOS.
      WA_POT2-STOCK = WA_POT1-STOCK.
      WA_POT2-P3 = WA_POT1-P3.
      IF THREED EQ 1.
        WA_POT2-NQTY1 = WA_POT1-NQTY11.
        WA_POT2-DQTY = WA_POT1-DQTY11.
      ELSE.
        WA_POT2-NQTY1 = WA_POT1-NQTY1.
        WA_POT2-DQTY = WA_POT1-DQTY.
      ENDIF.
      COLLECT WA_POT2 INTO IT_POT2.
      CLEAR WA_POT2.

      PERFORM UPDATE_POT1.

      POTQTY1 = POTQTY1 + WA_POT1-NQTY1.
      POTQTY2 = POTQTY2 + WA_POT1-DQTY.
      IF THREED EQ 1.
        POTQTY31 = POTQTY31 + WA_POT1-NQTY11.
        POTQTY32 = POTQTY32 + WA_POT1-DQTY11.
      ENDIF.
      COUNT1 = COUNT1 + 1.
      IF THREED EQ 1.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            ELEMENT = 'T11'
            WINDOW  = 'MAIN'.
      ELSE.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            ELEMENT = 'T1'
            WINDOW  = 'MAIN'.
      ENDIF.

    ENDLOOP.
    IF THREED EQ 1.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          ELEMENT = 'T21'
          WINDOW  = 'MAIN'.
    ELSE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          ELEMENT = 'T2'
          WINDOW  = 'MAIN'.

    ENDIF.
*    WRITE : /81 POTQTY1, POTQTY2.
    TOTPOTQTY1 = TOTPOTQTY1 + POTQTY1.
    TOTPOTQTY2 = TOTPOTQTY2 + POTQTY2.
    IF POTQTY32 GT 0.
      TOTPOTQTY3 = TOTPOTQTY3 + POTQTY32.
    ELSE.
      TOTPOTQTY3 = TOTPOTQTY3 + POTQTY2.
    ENDIF.
    CLEAR : POTQTY11,POTQTY12.
    IF THREED EQ 1.
      POTQTY11 = POTQTY31.
      POTQTY12 = POTQTY32.
    ELSE.
      POTQTY11 = POTQTY1.
      POTQTY12 = POTQTY2.
    ENDIF.
    CONDENSE: POTQTY11,POTQTY12.
    ADJMATNR = WA_MAT1-ADJMATNR.
    ADJPOSNR = WA_MAT1-ADJPOSNR.
    ADJCOUNT = WA_MAT1-COUNT.
    ADJMENGE = WA_MAT1-ADJMENGE.
    ADJMEINS = WA_MAT1-ADJMEINS.

    AT END OF ADJPOSNR.



*      FORMAT COLOR 3.
*      WRITE : / 'ADJUSTMENT'.
      SELECT SINGLE * FROM MAKT WHERE MATNR EQ ADJMATNR AND SPRAS EQ 'EN'.
      IF SY-SUBRC EQ 0.
        ADJMAKTX1 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MAKT WHERE MATNR EQ ADJMATNR AND SPRAS EQ 'Z1'.
      IF SY-SUBRC EQ 0.
        ADJMAKTX2 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MARA WHERE MATNR EQ ADJMATNR.
      IF SY-SUBRC EQ 0.
        ADJNORMT = MARA-NORMT.
      ENDIF.
      CONCATENATE ADJMAKTX1 ADJMAKTX2 ADJNORMT INTO ADJMAKTX SEPARATED BY SPACE.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          ELEMENT = 'T3'
          WINDOW  = 'MAIN'.
      CLEAR : ATXT1,ATXT2,ATXT3.
      CLEAR : COUNT3.
      CLEAR : COUNT31.
      LOOP AT IT_ZPOTENCY_BOM1 INTO WA_ZPOTENCY_BOM1 WHERE ADJMATNR EQ ADJMATNR AND ADJPOSNR EQ ADJPOSNR.
        COUNT31 = COUNT31 + 1.
      ENDLOOP.
      COUNT31 = COUNT31 - 1.
      CLEAR : THREED1.
      LOOP AT IT_ZPOTENCY_BOM1 INTO WA_ZPOTENCY_BOM1 WHERE ADJMATNR EQ ADJMATNR AND ADJPOSNR EQ ADJPOSNR.
        CLEAR : ATXT1,ADJMAKTX11.
*        ON CHANGE OF WA_ZPOTENCY_BOM1-ADJPOSNR.
*          THREED1 = 0.
*        ENDON.
*        BREAK-POINT.
        SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_ZPOTENCY_BOM1-IDNRK AND WERKS EQ PLANT.
        IF SY-SUBRC EQ 0.
          THREED1 = 1.
        ENDIF.

        ADJTXT1 = WA_ZPOTENCY_BOM1-IDNRK.
        SELECT SINGLE * FROM MAKT WHERE MATNR EQ ADJTXT1 AND SPRAS EQ 'EN'.
        IF SY-SUBRC EQ 0.
          SELECT SINGLE * FROM MARA WHERE MATNR EQ MAKT-MATNR.
          IF SY-SUBRC EQ 0.
            IF COUNT3 LT COUNT31.
              CONCATENATE MAKT-MAKTX MARA-NORMT '+' INTO ATXT1 SEPARATED BY SPACE.
            ELSE.
              CONCATENATE MAKT-MAKTX MARA-NORMT INTO ATXT1 SEPARATED BY SPACE.
            ENDIF.
          ENDIF.
        ENDIF.
        CONDENSE :ADJTXT1,ACTTXT1.
*        CONCATENATE ADJTXT2 ADJTXT1 INTO ADJTXT2 SEPARATED BY ','.
*        CONDENSE ADJTXT2.
        CONCATENATE ATXT2 ATXT1 INTO ATXT2 SEPARATED BY SPACE.
        CONDENSE ATXT2.
        IF COUNT3 EQ 0.
          ADJMAKTX11 = ADJMAKTX.
        ENDIF.
        CALL FUNCTION 'WRITE_FORM'
          EXPORTING
            ELEMENT = 'T4'
            WINDOW  = 'MAIN'.
        COUNT3 = COUNT3 + 1.
      ENDLOOP.
      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          ELEMENT = 'T5'
          WINDOW  = 'MAIN'.
      CONCATENATE ATXT2 '+' ADJMAKTX INTO ATXT3 SEPARATED BY SPACE.
      CONDENSE : ATXT3,ATXT2.
*      WRITE : / 'CALCULATION FOR ',ADJMATNR, ADJMAKTX.
*      WRITE : / ADJTXT2, '+',ADJMATNR, 50 ADJTXT2, 100 ADJMATNR.
      TOTMENGE1 = TMENGE1 + ADJMENGE.
*      WRITE : / 'tot qty',TOTMENGE1, 'active qty disp',TOTPOTQTY2.
      AAQTY1 = TOTMENGE1.
*      AAQTY2 = TOTPOTQTY2.
*      BREAK-POINT.
      IF THREED1 EQ 1.
        AAQTY2 = TOTPOTQTY3.
      ELSE.
        AAQTY2 = TOTPOTQTY2.
      ENDIF.
      IF THREED1 EQ 1.
        TMENGE2 = TOTMENGE1 - TOTPOTQTY3.
      ELSE.
        TMENGE2 = TOTMENGE1 - TOTPOTQTY2.
      ENDIF.
*      WRITE : 'adj qty',TMENGE2.
      AAQTY3 = TMENGE2.

      CALL FUNCTION 'WRITE_FORM'
        EXPORTING
          ELEMENT = 'T6'
          WINDOW  = 'MAIN'.
*      CLEAR : AMAKTX,BMAKTX,BMAKTX1,BMAKTX2,AAQTY1,AAQTY2,AAQTY3,AMAKTX3.
*      WRITE : / 'adj1',ADJMATNR,ADJMENGE,ADJMEINS.
*      WRITE : / 'adj3',WA_POS1-AMAKTX.
*      AMAKTX3 = WA_POS1-AMAKTX.
*      WRITE : / WA_POS1-BMAKTX, WA_POS1-BMAKTX1, WA_POS1-BMAKTX2.
*      BMAKTX = WA_POS1-BMAKTX.
*      BMAKTX1 = WA_POS1-BMAKTX1.
*      BMAKTX2 = WA_POS1-BMAKTX2.
*      WRITE : / '***',TOTPOTQTY1,TOTPOTQTY2.
*      WRITE : / '**',WA_POS1-AQTY1, WA_POS1-STOCK2, WA_POS1-ADJQTY.
*      AAQTY1 = WA_POS1-AQTY1.
*      AAQTY2 = WA_POS1-STOCK2.
*      AAQTY3 = WA_POS1-ADJQTY.
**      ENDLOOP.
*      ULINE.

      TOTPOTQTY1 = 0.
      TOTPOTQTY2 = 0.
      TOTPOTQTY3 = 0.
      TMENGE1 = 0.
      TOTMENGE1 = 0.
      TMENGE2 = 0.
      ADJMENGE = 0.
      COUNT4 = COUNT4 + 1.
    ENDAT.


    BCOUNT1 = BCOUNT1 + 1.
    CLEAR : ACTTXT1,ACTTXT2,ACTTXT3.
    SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAT1-MATNR AND SPRAS EQ 'EN'.
    IF SY-SUBRC EQ 0.
      ACTTXT1 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAT1-MATNR AND SPRAS EQ 'Z1'.
    IF SY-SUBRC EQ 0.
      ACTTXT2 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR .
    IF SY-SUBRC EQ 0.
      ACTTXT3 = MARA-NORMT.
    ENDIF.
    CONCATENATE ACTTXT1 ACTTXT2 ACTTXT3 INTO AMAKTX SEPARATED BY SPACE.

    CONDENSE : AAQTY1,AAQTY2,AAQTY3,BMAKTX,BMAKTX1,BMAKTX2.
    CLEAR : MATNR2.
    MATNR2   = WA_MAT1-MATNR.
    PACK MATNR2 TO MATNR2.
    CONDENSE MATNR2.
    CHARG = BATCH.



*    CLEAR : IT_POT2.
    ON CHANGE OF WA_MAT1-POTX1.
      COUNT2 = COUNT2 + 1.
    ENDON.




*    CALL FUNCTION V_FM
*      EXPORTING
*        CONTROL_PARAMETERS = CONTROL
*        USER_SETTINGS      = 'X'
*        OUTPUT_OPTIONS     = W_SSFCOMPOP
*        FORMAT             = FORMAT
*        POTQTY11           = POTQTY11
*        POTQTY12           = POTQTY12
*        AMAKTX             = AMAKTX
*        BMAKTX             = BMAKTX
*        BMAKTX1            = BMAKTX1
*        BMAKTX2            = BMAKTX2
*        AAQTY1             = AAQTY1
*        AAQTY2             = AAQTY2
*        AAQTY3             = AAQTY3
*        MATNR2             = MATNR2
*        MENGE1             = MENGE1
*        TEXT               = TEXT
**       COUNT              = WA_MAT1-COUNT
*        COUNT              = COUNT2
*        ORT01              = ORT01
*        MAKTX              = MAKTX
*        CHARG              = CHARG
*        FGMAKTX            = FGMAKTX
*        FGMATNR            = FGMATNR
*        AMAKTX3            = AMAKTX3
*        FGMEINS            = FGMEINS
*        ADJCNT             = ADJCNT
*        ADJMAKTX           = ADJMAKTX
*        ADJMATNR           = ADJMATNR
*        ATXT2              = ATXT2
*        ATXT3              = ATXT3
**       MATNR              = MATNR
**       MAKTX              = MAKTX
**       ZTEXT              = ZTEXT
**       STKTX              = STKTX
**       BQTY               = BQTY
**       MEINS              = MEINS
**       MAST               = MAST
**       KUNNR              = KUNNR
**       STLAN              = WA_CHECK-STLAN
**       STLAL              = WA_CHECK-STLAL
**       SHELFLIFE          = SHELFLIFE
**       j_1imocust         = j_1imocust
**       g_lstno            = g_lstno
**       wa_adrc            = wa_adrc
**       vbkd               = vbkd
**       vbak               = vbak
**       total              = total
**       total1             = total1
**       vbrk               = vbrk
**       w_tax              = w_tax
**       w_value            = w_value
**       spell              = spell
**       w_diff             = w_diff
**       emname             = emname
**       rmname             = rmname
**       clmdt              = clmdt
*      TABLES
*        IT_POT2            = IT_POT2
**       itab_division      = itab_division
**       itab_storage       = itab_storage
**       itab_pa0002        = itab_pa0002
*      EXCEPTIONS
*        FORMATTING_ERROR   = 1
*        INTERNAL_ERROR     = 2
*        SEND_ERROR         = 3
*        USER_CANCELED      = 4
*        OTHERS             = 5.

    CLEAR : IT_POT2.
    CLEAR : ADJCNT.
*    CLEAR : count2.
    PAGE1 = PAGE1 + 1.
  ENDLOOP.

  CALL FUNCTION 'END_FORM'
    EXCEPTIONS
      UNOPENED                 = 1
      BAD_PAGEFORMAT_FOR_PRINT = 2
      SPOOL_ERROR              = 3
      CODEPAGE                 = 4
      OTHERS                   = 5.
  IF SY-SUBRC <> 0.
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

  CALL FUNCTION 'CLOSE_FORM'
* IMPORTING
*   RESULT                         =
*   RDI_RESULT                     =
* TABLES
*   OTFDATA                        =
    EXCEPTIONS
      UNOPENED                 = 1
      BAD_PAGEFORMAT_FOR_PRINT = 2
      SEND_ERROR               = 3
      SPOOL_ERROR              = 4
      CODEPAGE                 = 5
      OTHERS                   = 6.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

*  CALL FUNCTION 'SSF_CLOSE'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  AADJ
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM AADJ .
  LOOP AT IT_MAST INTO WA_MAST.
    CLEAR : WRKST.
    LOOP AT IT_STAS INTO WA_STAS WHERE STLNR = WA_MAST-STLNR AND STLAL = WA_MAST-STLAL.
      LOOP AT IT_STPO INTO WA_STPO WHERE STLNR = WA_STAS-STLNR AND STLKN = WA_STAS-STLKN AND SORTF NE SPACE.
        READ TABLE IT_TAB2 INTO WA_TAB2 WITH KEY SORTF = WA_STPO-IDNRK.
        IF SY-SUBRC EQ 0.
*       AND IDNRK CS 'H'.
*          WRITE : / 'ADJ',WA_STPO-IDNRK,WA_STPO-MENGE,WA_STPO-POSNR.
          WA_ADJ1-MATNR = WA_STPO-IDNRK.
          WA_ADJ1-MENGE = WA_STPO-MENGE.
          WA_ADJ1-MEINS = WA_STPO-MEINS.
          WA_ADJ1-POSNR = WA_STPO-POSNR.
          COLLECT WA_ADJ1 INTO IT_ADJ1.
          CLEAR WA_ADJ1.
        ENDIF.
      ENDLOOP.
    ENDLOOP.
  ENDLOOP.

  SORT IT_ADJ1 BY POSNR.
  CLEAR : COUNT.
  LOOP AT IT_ADJ1 INTO WA_ADJ1.
    COUNT = COUNT + 1.
    WA_ADJ2-MATNR = WA_ADJ1-MATNR.
    WA_ADJ2-MENGE = WA_ADJ1-MENGE.
    WA_ADJ2-MEINS = WA_ADJ1-MEINS.
    WA_ADJ2-POSNR = WA_ADJ1-POSNR.
    WA_ADJ2-COUNT = COUNT.
    COLLECT WA_ADJ2 INTO IT_ADJ2.
    CLEAR WA_ADJ2.
  ENDLOOP.

*  LOOP AT IT_ADJ2 INTO WA_ADJ2.
*    WRITE : / 'ADJ*', WA_ADJ2-POSNR,WA_ADJ2-MATNR,WA_ADJ2-MENGE,WA_ADJ2-COUNT.
*  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APOTENCY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM APOTENCY .

*  IF S1 EQ 'L'.
*    IF WA_MCHB-MATNR = WA_MAT1-MATNR.
*      TQTY1 = WA_MAT1-MENGE - TQTY1.
*    ELSEIF WA_MCHB-MATNR = WA_MAT1-ADJMATNR.
*      TQTY1 = WA_MAT1-ADJMENGE - TQTY1.
*    ENDIF.
*    TQTY2 = TQTY1.
*    WRITE : 15 TQTY2 LEFT-JUSTIFIED.
*
**    STOCK2 = STOCK2 + TQTY2.
*    TQTY1 = 0.
*  ELSE.
**    WRITE : / '         ','*****'.
**    STOCK2 = STOCK2 + STOCK1.
*  ENDIF.
*  WA_POT1-TQTY2 = TQTY2.

  READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
  IF SY-SUBRC EQ 0.
*    WRITE : 30  WA_QALS-PRUEFLOS.
    WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
    CLEAR : P1,P2,P3.
    SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    IF SY-SUBRC EQ 0.
      P3 = ZINSPPOT-UPOT.
*      TEXT = ZINSPPOT-SGTXT.
      WA_POT1-P3 = P3.
      CONDENSE WA_POT1-P3.
*      WA_POT1-TEXT = TEXT.
    ENDIF.
    IF P3 LE 0.
      CLEAR : PVAL1.
      SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
      IF SY-SUBRC EQ 0.
        SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
        IF SY-SUBRC EQ 0.
          PVAL1 = QAMR-ORIGINAL_INPUT.
          CONDENSE PVAL1.
          P3 = PVAL1.
        ENDIF.
      ENDIF.
      WA_POT1-P3 = P3.
      CONDENSE WA_POT1-P3.
    ENDIF.
    PERFORM APOT1.
  ENDIF.
*  SKIP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APOT1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM APOT1 .

  CLEAR : THREED.
  SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_ZMCHB-MATNR.
  IF SY-SUBRC EQ 0.
    THREED = 1.  "for 3 decimal.
    PERFORM APOT11.
  ELSE.
    PERFORM APOT12.
  ENDIF.



ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  INACTIVEBOM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM INACTIVEBOM .
  SELECT SINGLE * FROM MAST WHERE MATNR EQ MATNR AND WERKS EQ PLANT AND STLAL EQ BOM.
  IF SY-SUBRC EQ 0.
    SELECT SINGLE * FROM STKO WHERE STLNR EQ MAST-STLNR AND STLAL EQ BOM AND STLST EQ '01'.
    IF SY-SUBRC NE 0.
      MESSAGE 'INACTIVE BOM -- PLEASE CHECK' TYPE 'E'.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  POT11
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM POT11 .
  CLEAR : QTY1,QTY11.
  CLEAR : NQTY1,NQTY11.
**************cedon*****************
  CLEAR : CED.
  IF MATNR EQ 'G15107' OR MATNR EQ 'G15108' OR MATNR EQ 'G15106'.
*  IF matnr EQ 'H15107' OR matnr EQ 'H15108' OR matnr EQ 'H15106'.

    CED = 73206 / 1000.

    IF S1 EQ 'L'.  "LAST CALCULATION
*    QTY1 = STOCK1 * ( 100 / P3 ).
      IF P3 GT 0.
*      QTY1 = TQTY2 * ( 100 / P3 ).
        QTY11 = STOCK1 * ( CED / P3 ).
      ENDIF.
    ELSE.
      QTY11 = STOCK1 * ( P3 / CED ).
    ENDIF.
    IF QTY11 GT STOCK1.
      IF S1 NE 'L'.
        QTY11 = STOCK1.
      ENDIF.
    ENDIF.

    NQTY1 = STOCK1 * ( P3 / CED ).
    NQTY11 = STOCK1 * ( P3 / CED ).
    CLEAR : CQTY1.
    IF NQTY11 GT STOCK1.
      CQTY1 = NQTY11 - STOCK1.
    ENDIF.
    WA_POT1-QTY11 = QTY11.
    IF S1 EQ 'L'.
      STOCK2 = STOCK2 + QTY11.
    ELSE.
      STOCK2 = STOCK2 + STOCK1.
    ENDIF.
    CLEAR : RQTY.
    RQTY = WA_POT1-STOCK - QTY11.
*    IF WA_POT1-STOCK GT QTY1.
*      WA_POT1-DQTY = WA_POT1-STOCK .
*    ELSE.
    WA_POT1-DQTY = QTY11.
    WA_POT1-DQTY11 = QTY11.
*    ENDIF.

  ELSE.

    CLEAR : CED2.
    IF WA_ZMCHB-MATNR EQ '000000000000100693'.
      CED2 = 700.
    ELSEIF WA_ZMCHB-MATNR EQ '000000000000100110'.
      CED2 = 1000.
    ELSE.
      CED2 = 100.
    ENDIF.

    IF S1 EQ 'L'.
*    QTY1 = STOCK1 * ( 100 / P3 ).
      IF P3 GT 0.
*      QTY1 = TQTY2 * ( 100 / P3 ).
*        IF P3 GT 100.
        IF P3 GT CED2.
          QTY11 = STOCK1.
        ELSE.
*          QTY11 = STOCK1 * ( 100 / P3 ).
          QTY11 = STOCK1 * ( CED2 / P3 ).
        ENDIF.
      ENDIF.
    ELSE.
*      IF P3 GT 100.
      IF P3 GT CED2.
        QTY11 = STOCK1.
      ELSE.
*        QTY11 = STOCK1 * ( P3 / 100 ).
        QTY11 = STOCK1 * ( P3 / CED2 ).
      ENDIF.
    ENDIF.
    IF QTY11 GT STOCK1.
      IF S1 NE 'L'.
        QTY11 = STOCK1.
      ENDIF.
    ENDIF.
*    IF P3 GT 100.
    IF P3 GT CED2.
      NQTY11 = STOCK1.
    ELSE.
*      NQTY11 = STOCK1 * ( P3 / 100 ).
      NQTY11 = STOCK1 * ( P3 / CED2 ).
    ENDIF.

*    IF WA_MAT1-MENGE GT WA_ZMCHB-CLABS.
*      STOCK = WA_MAT1-MENGE - NQTY11.
*    ELSE.
*      IF NQTY11 GT STOCK1.
*        NQTY11 = STOCK1.
*      ENDIF.
*    ENDIF.

    IF NQTY11 GT STOCK1.
      NQTY11 = STOCK1.
    ENDIF.

    WA_POT1-QTY1 = QTY11.
    WA_POT1-QTY11 = QTY11.
    IF S1 EQ 'L'.
      STOCK2 = STOCK2 + QTY11.
    ELSE.
      STOCK2 = STOCK2 + STOCK1.
    ENDIF.
    CLEAR : RQTY,RQTY1.
    RQTY = WA_POT1-STOCK - QTY11.
    RQTY1 = WA_POT1-STOCK - QTY11.

    IF WA_POT1-STOCK  GT QTY11.
      WA_POT1-DQTY = WA_POT1-STOCK .
      WA_POT1-DQTY11 = WA_POT1-STOCK .
    ELSE.
      WA_POT1-DQTY = QTY11.
      WA_POT1-DQTY11 = QTY11.
    ENDIF.
  ENDIF.



*    IF S1 EQ 'L'.
**    QTY1 = STOCK1 * ( 100 / P3 ).
*      IF P3 GT 0.
**      QTY1 = TQTY2 * ( 100 / P3 ).
*        IF P3 GT 100.
*          QTY11 = STOCK1.
*        ELSE.
*          QTY11 = STOCK1 * ( 100 / P3 ).
*        ENDIF.
*      ENDIF.
*    ELSE.
*      IF P3 GT 100.
*        QTY11 = STOCK1.
*      ELSE.
*        QTY11 = STOCK1 * ( P3 / 100 ).
*      ENDIF.
*    ENDIF.
*    IF QTY11 GT STOCK1.
*      IF S1 NE 'L'.
*        QTY11 = STOCK1.
*      ENDIF.
*    ENDIF.
*    IF P3 GT 100.
*      NQTY11 = STOCK1.
*    ELSE.
*      NQTY11 = STOCK1 * ( P3 / 100 ).
*    ENDIF.
*    IF WA_MAT1-MENGE GT WA_ZMCHB-CLABS.
*      STOCK = WA_MAT1-MENGE - NQTY11.
*    ELSE.
*      IF NQTY11 GT STOCK1.
*        NQTY11 = STOCK1.
*      ENDIF.
*    ENDIF.
*    WA_POT1-QTY1 = QTY11.
*    WA_POT1-QTY11 = QTY11.
*    IF S1 EQ 'L'.
*      STOCK2 = STOCK2 + QTY11.
*    ELSE.
*      STOCK2 = STOCK2 + STOCK1.
*    ENDIF.
*    CLEAR : RQTY.
*    RQTY = WA_POT1-STOCK - QTY11.
*    IF WA_POT1-STOCK  GT QTY11.
*      WA_POT1-DQTY = WA_POT1-STOCK .
*      WA_POT1-DQTY11 = WA_POT1-STOCK .
*    ELSE.
*      WA_POT1-DQTY = QTY11.
*      WA_POT1-DQTY11 = QTY11.
*    ENDIF.
*  ENDIF.


*************************************



  WA_POT1-NQTY1 = NQTY11.
  WA_POT1-NQTY11 = NQTY11.

  TQTY1 = TQTY1 + QTY1.
*  P3 = P1 - P2.
*  WRITE :  p3 .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  POT12
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM POT12 .
  CLEAR : QTY1.
  CLEAR : NQTY1.
**************cedon*****************
  CLEAR : CED.
  IF MATNR EQ 'G15107' OR MATNR EQ 'G15108' OR MATNR EQ 'G15106'.
*  IF matnr EQ 'H15107' OR matnr EQ 'H15108' OR matnr EQ 'H15106'.

    CED = 73206 / 1000.

    IF S1 EQ 'L'.  "LAST CALCULATION
*    QTY1 = STOCK1 * ( 100 / P3 ).
      IF P3 GT 0.
*      QTY1 = TQTY2 * ( 100 / P3 ).
        QTY1 = STOCK1 * ( CED / P3 ).
      ENDIF.
    ELSE.
      QTY1 = STOCK1 * ( P3 / CED ).
    ENDIF.
*    IF QTY1 GT STOCK1.
    IF QTY1 LT STOCK1.
      IF S1 NE 'L'.
        QTY1 = STOCK1.
      ENDIF.
    ENDIF.

    NQTY1 = STOCK1 * ( P3 / CED ).
    CLEAR : CQTY1.
    IF NQTY1 GT STOCK1.
      CQTY1 = NQTY1 - STOCK1.
    ENDIF.
    WA_POT1-QTY1 = QTY1.
    IF S1 EQ 'L'.
      STOCK2 = STOCK2 + QTY1.
    ELSE.
      STOCK2 = STOCK2 + STOCK1.
    ENDIF.
    CLEAR : RQTY.
    RQTY = WA_POT1-STOCK - QTY1.
*    IF WA_POT1-STOCK GT QTY1.
*      WA_POT1-DQTY = WA_POT1-STOCK .
*    ELSE.
    WA_POT1-DQTY = QTY1.
*    ENDIF.

  ELSE.
    IF S1 EQ 'L'.
*    QTY1 = STOCK1 * ( 100 / P3 ).
      IF P3 GT 0.
        IF P3 GT 100.
          QTY1 = STOCK1.
        ELSE.
*      QTY1 = TQTY2 * ( 100 / P3 ).
          QTY1 = STOCK1 * ( 100 / P3 ).
        ENDIF.
      ENDIF.
    ELSE.
      QTY1 = STOCK1 * ( P3 / 100 ).
    ENDIF.
    IF QTY1 GT STOCK1.
      IF S1 NE 'L'.
        QTY1 = STOCK1.
      ENDIF.
    ENDIF.
    NQTY1 = STOCK1 * ( P3 / 100 ).

    IF NQTY1 GT STOCK1.
      NQTY1 = STOCK1.
    ENDIF.
    WA_POT1-QTY1 = QTY1.
    IF S1 EQ 'L'.
      STOCK2 = STOCK2 + QTY1.
    ELSE.
      STOCK2 = STOCK2 + STOCK1.
    ENDIF.
    CLEAR : RQTY.
    RQTY = WA_POT1-STOCK - QTY1.
    IF WA_POT1-STOCK  GT QTY1.
      WA_POT1-DQTY = WA_POT1-STOCK .
    ELSE.
      WA_POT1-DQTY = QTY1.
    ENDIF.
  ENDIF.

*************************************




  WA_POT1-NQTY1 = NQTY1.

  TQTY1 = TQTY1 + QTY1.
*  P3 = P1 - P2.
*  WRITE :  p3 .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ACTIVEBOM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ACTIVEBOM .

  SELECT * FROM MAST INTO TABLE IT_MAST_1 WHERE MATNR EQ MATNR AND WERKS EQ PLANT.
  IF SY-SUBRC EQ 0.
    SELECT * FROM STKO INTO TABLE IT_STKO_1 FOR ALL ENTRIES IN IT_MAST_1 WHERE STLNR EQ IT_MAST_1-STLNR AND STLAL EQ IT_MAST_1-STLAL AND STLST EQ '01'.
  ENDIF.

  LOOP AT IT_MAST_1 INTO WA_MAST_1.
    READ TABLE IT_STKO_1 INTO WA_STKO_1 WITH KEY STLNR = WA_MAST_1-STLNR STLAL = WA_MAST_1-STLAL.
    IF SY-SUBRC EQ 0.
      SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAST_1-MATNR AND MTART EQ 'ZHLB'.
      IF SY-SUBRC EQ 0.
        WA_BOM1-MATNR = WA_MAST_1-MATNR.
        WA_BOM1-STLAL = WA_MAST_1-STLAL.
        WA_BOM1-BMENG = WA_STKO_1-BMENG.
        WA_BOM1-BMEIN = WA_STKO_1-BMEIN.
        SELECT SINGLE * FROM MAKT WHERE MATNR EQ WA_MAST_1-MATNR AND SPRAS EQ 'EN'.
        IF SY-SUBRC EQ 0.
          WA_BOM1-MAKTX = MAKT-MAKTX.
        ENDIF.
        COLLECT WA_BOM1 INTO IT_BOM1.
        CLEAR WA_BOM1.
      ENDIF.
    ENDIF.
  ENDLOOP.


  WA_FIELDCAT-FIELDNAME = 'MATNR'.
  WA_FIELDCAT-SELTEXT_L = 'HALB CODE'.
  APPEND WA_FIELDCAT TO FIELDCAT.

  WA_FIELDCAT-FIELDNAME = 'MAKTX'.
  WA_FIELDCAT-SELTEXT_L = 'HALB CODE DESCRIPTION'.
  APPEND WA_FIELDCAT TO FIELDCAT.

  WA_FIELDCAT-FIELDNAME = 'STLAL'.
  WA_FIELDCAT-SELTEXT_L = 'BOM NO.'.
  APPEND WA_FIELDCAT TO FIELDCAT.

  WA_FIELDCAT-FIELDNAME = 'BMENG'.
  WA_FIELDCAT-SELTEXT_L = 'BASE QTY'.
  APPEND WA_FIELDCAT TO FIELDCAT.

  WA_FIELDCAT-FIELDNAME = 'BMEIN'.
  WA_FIELDCAT-SELTEXT_L = 'BASE UNIT'.
  APPEND WA_FIELDCAT TO FIELDCAT.



  LAYOUT-ZEBRA = 'X'.
  LAYOUT-COLWIDTH_OPTIMIZE = 'X'.
  LAYOUT-WINDOW_TITLEBAR  = 'ACTIVE BOM FOR HALB CODE'.


  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
*     I_INTERFACE_CHECK       = ' '
*     I_BYPASSING_BUFFER      = ' '
*     I_BUFFER_ACTIVE         = ' '
      I_CALLBACK_PROGRAM      = G_REPID
*     I_CALLBACK_PF_STATUS_SET          = ' '
      I_CALLBACK_USER_COMMAND = 'USER_COMM'
      I_CALLBACK_TOP_OF_PAGE  = 'TOP'
*     I_CALLBACK_HTML_TOP_OF_PAGE       = ' '
*     I_CALLBACK_HTML_END_OF_LIST       = ' '
*     I_STRUCTURE_NAME        =
*     I_BACKGROUND_ID         = ' '
*     I_GRID_TITLE            =
*     I_GRID_SETTINGS         =
      IS_LAYOUT               = LAYOUT
      IT_FIELDCAT             = FIELDCAT
*     IT_EXCLUDING            =
*     IT_SPECIAL_GROUPS       =
*     IT_SORT                 =
*     IT_FILTER               =
*     IS_SEL_HIDE             =
*     I_DEFAULT               = 'X'
      I_SAVE                  = 'A'
*     IS_VARIANT              =
*     IT_EVENTS               =
*     IT_EVENT_EXIT           =
*     IS_PRINT                =
*     IS_REPREP_ID            =
*     I_SCREEN_START_COLUMN   = 0
*     I_SCREEN_START_LINE     = 0
*     I_SCREEN_END_COLUMN     = 0
*     I_SCREEN_END_LINE       = 0
*     I_HTML_HEIGHT_TOP       = 0
*     I_HTML_HEIGHT_END       = 0
*     IT_ALV_GRAPHICS         =
*     IT_HYPERLINK            =
*     IT_ADD_FIELDCAT         =
*     IT_EXCEPT_QINFO         =
*     IR_SALV_FULLSCREEN_ADAPTER        =
* IMPORTING
*     E_EXIT_CAUSED_BY_CALLER =
*     ES_EXIT_CAUSED_BY_USER  =
    TABLES
      T_OUTTAB                = IT_BOM1
    EXCEPTIONS
      PROGRAM_ERROR           = 1
      OTHERS                  = 2.
  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
  ENDIF.

ENDFORM.

FORM TOP.
  DATA: COMMENT    TYPE SLIS_T_LISTHEADER,
        WA_COMMENT LIKE LINE OF COMMENT.

  WA_COMMENT-TYP = 'A'.
  WA_COMMENT-INFO = 'ACTIVE BOM FOR HALB CODE'.
*  WA_COMMENT-INFO = P_FRMDT.
  APPEND WA_COMMENT TO COMMENT.

  CALL FUNCTION 'REUSE_ALV_COMMENTARY_WRITE'
    EXPORTING
      IT_LIST_COMMENTARY = COMMENT
*     I_LOGO             = 'ENJOYSAP_LOGO'
*     I_END_OF_LIST_GRID =
*     I_ALV_FORM         =
    .

  CLEAR COMMENT.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  AUTHORIZATION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM AUTHORIZATION.

  IF R1 EQ 'X'.
    AUTHORITY-CHECK OBJECT 'M_BCO_WERK' ID 'WERKS' FIELD PLANT.
    IF SY-SUBRC <> 0.
      CONCATENATE 'No authorization for Plant' PLANT INTO MSG
      SEPARATED BY SPACE.
      MESSAGE MSG TYPE 'E'.
    ENDIF.
  ENDIF.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APOT11
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM APOT11 .
  CLEAR : QTY11.
  CLEAR : NQTY11.
  IF S1 EQ 'L'.
*    QTY1 = STOCK1 * ( 100 / P3 ).
    IF P3 GT 0.
*      QTY1 = TQTY2 * ( 100 / P3 ).
      IF P3 GT 100.
        QTY11 = STOCK1.
      ELSE.
        QTY11 = STOCK1 * ( 100 / P3 ).
      ENDIF.
    ENDIF.
  ELSE.
    IF P3 GT 100.
      QTY11 = STOCK1.
    ELSE.
      QTY11 = STOCK1 * ( P3 / 100 ).
    ENDIF.
  ENDIF.
  IF QTY11 GT STOCK1.
    IF S1 NE 'L'.
      QTY11 = STOCK1.
    ENDIF.
  ENDIF.
  IF P3 GT 100.
    NQTY11 = STOCK1.
  ELSE.
    NQTY11 = STOCK1 * ( P3 / 100 ).
  ENDIF.

  IF NQTY11 GT STOCK1.
    NQTY11 = STOCK1.
  ENDIF.
*  WRITE : 60 QTY1 LEFT-JUSTIFIED.
  WA_POT1-QTY1 = QTY11.
  WA_POT1-QTY11 = QTY11.
  IF S1 EQ 'L'.
    STOCK2 = STOCK2 + QTY11.
  ELSE.
    STOCK2 = STOCK2 + STOCK1.
  ENDIF.
  CLEAR : RQTY.
  RQTY = WA_POT1-STOCK - QTY11.
  IF WA_POT1-STOCK  GT QTY11.
    WA_POT1-DQTY = WA_POT1-STOCK .
    WA_POT1-DQTY11 = WA_POT1-STOCK .
  ELSE.
    WA_POT1-DQTY = QTY11.
    WA_POT1-DQTY11 = QTY11.
  ENDIF.
  WA_POT1-NQTY1 = NQTY11.
  WA_POT1-NQTY11 = NQTY11.

  TQTY1 = TQTY1 + QTY11.
*  P3 = P1 - P2.
*  WRITE :  p3 .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  APOT12
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM APOT12 .
  CLEAR : QTY1.
  CLEAR : NQTY1.
  IF S1 EQ 'L'.
*    QTY1 = STOCK1 * ( 100 / P3 ).
    IF P3 GT 0.
*      QTY1 = TQTY2 * ( 100 / P3 ).
      IF P3 GT 100.
        QTY1 = STOCK1.
      ELSE.
        QTY1 = STOCK1 * ( 100 / P3 ).
      ENDIF.
    ENDIF.
  ELSE.
    IF P3 GT 100.
      QTY1 = STOCK1.
    ELSE.
      QTY1 = STOCK1 * ( P3 / 100 ).
    ENDIF.
  ENDIF.
  IF QTY1 GT STOCK1.
    IF S1 NE 'L'.
      QTY1 = STOCK1.
    ENDIF.
  ENDIF.
  IF P3 GT 100.
    NQTY1 = STOCK1.
  ELSE.
    NQTY1 = STOCK1 * ( P3 / 100 ).
  ENDIF.

  IF NQTY1 GT STOCK1.
    NQTY1 = STOCK1.
  ENDIF.
*  WRITE : 60 QTY1 LEFT-JUSTIFIED.
  WA_POT1-QTY1 = QTY1.
  IF S1 EQ 'L'.
    STOCK2 = STOCK2 + QTY1.
  ELSE.
    STOCK2 = STOCK2 + STOCK1.
  ENDIF.
  CLEAR : RQTY.
  RQTY = WA_POT1-STOCK - QTY1.
  IF WA_POT1-STOCK  GT QTY1.
    WA_POT1-DQTY = WA_POT1-STOCK .
  ELSE.
    WA_POT1-DQTY = QTY1.
  ENDIF.
  WA_POT1-NQTY1 = NQTY1.

  TQTY1 = TQTY1 + QTY1.
*  P3 = P1 - P2.
*  WRITE :  p3 .
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GOASTOCK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GOASTOCK .
*  IF IT_TAB3 IS NOT INITIAL.
  SORT IT_MCHB BY MATNR WERKS CHARG.
  DELETE IT_MCHB WHERE CLABS EQ 0.
  IF IT_MCHB IS NOT INITIAL.
    SELECT * FROM QALS INTO TABLE IT_QALS FOR ALL ENTRIES IN IT_MCHB WHERE MATNR EQ IT_MCHB-MATNR AND WERK EQ IT_MCHB-WERKS AND CHARG EQ IT_MCHB-CHARG.
  ENDIF.

  SORT IT_QALS DESCENDING BY ENSTEHDAT.

  LOOP AT IT_QALS INTO WA_QALS.
    SELECT SINGLE * FROM JEST WHERE OBJNR EQ WA_QALS-OBJNR AND STAT EQ 'I0224'.
    IF SY-SUBRC EQ 0.
      DELETE IT_QALS WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    ENDIF.
  ENDLOOP.
*  FORMAT COLOR 2.

  LOOP AT IT_MCHB INTO WA_MCHB.
    WA_ZMCHB-MATNR = WA_MCHB-MATNR.
    WA_ZMCHB-WERKS = WA_MCHB-WERKS.
    WA_ZMCHB-LGORT = WA_MCHB-LGORT.
    WA_ZMCHB-CHARG = WA_MCHB-CHARG.
    WA_ZMCHB-CLABS = WA_MCHB-CLABS.
    SELECT SINGLE * FROM MCHA WHERE MATNR EQ WA_MCHB-MATNR AND WERKS EQ WA_MCHB-WERKS AND CHARG EQ WA_MCHB-CHARG.
    IF SY-SUBRC EQ 0.
      IF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR1.  "FOLLOW FIFO in insue-material exist.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR2.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR3.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR4.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR5.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR6.
      ELSE.
        WA_ZMCHB-VFDAT = MCHA-VFDAT.
      ENDIF.
*      WA_ZMCHB-VFDAT = MCHA-VFDAT.
      WA_ZMCHB-LWEDT = MCHA-LWEDT.
    ENDIF.
    COLLECT WA_ZMCHB INTO IT_ZMCHB.
    CLEAR WA_ZMCHB.
    CLEAR : WA_MCHB.
  ENDLOOP.
  SORT IT_ZMCHB BY MATNR VFDAT LWEDT.

  LOOP AT IT_MAT1 INTO WA_MAT1.

*    FORMAT COLOR 5.
*    WRITE : / WA_MAT1-MATNR,WA_MAT1-POTX1.

    CLEAR : MAKTX1,MAKTX2,MAKTX,NORMT.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX1 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX2 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      NORMT = MARA-NORMT.
    ENDIF.
    CONCATENATE MAKTX1 MAKTX2 NORMT INTO MAKTX SEPARATED BY SPACE.
    CONDENSE MAKTX.
*    WRITE : / 'Potency calculation for',MAKTX.
    CLEAR : MAKTX4,MQTY1.
    MQTY1 = WA_MAT1-MENGE.
    CONDENSE MQTY1.
*    CONCATENATE 'Theoritical qty of ' MAKTX 'per lot = ' MQTY1 WA_MAT1-MEINS 'as 100% on as such basis' INTO MAKTX4
    CONCATENATE 'THEORITICAL QTY OF ' MAKTX 'PER LOT = ' MQTY1 WA_MAT1-MEINS INTO MAKTX4  SEPARATED BY SPACE.
*    'AS 100% ON ' TEXT


*    WRITE : / MAKTX4.
    TQTY1 = 0.
    TQTY2 = 0.
    CLEAR : STOCK.
*    STOCK = WA_MAT1-MENGE.
    STOCK = WA_MAT1-MENGE1.
*    FORMAT COLOR 3.
    CLEAR : STOCK2.
*    WRITE : /1 'BATCH',15 'AVAILABLE QTY', 30 'INSPECTION LOT', 50 'POTENCY', 60 'QTY AS PER ASSAY'.
*    ,80 'DISPENSED QTY'.
*    BREAK-POINT .
    CLEAR : STOCK2.
    CLEAR :NC1.
    CLEAR : CHK1.
    LOOP AT IT_ZMCHB INTO WA_ZMCHB WHERE MATNR = WA_MAT1-MATNR.

      CLEAR : THREED.
      SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_ZMCHB-MATNR.
      IF SY-SUBRC EQ 0.
        THREED = 1.  "for 3 decimal.
      ENDIF.

      CLEAR : CED2.
      IF WA_ZMCHB-MATNR EQ '000000000000100693'.
        CED2 = 700.
      ELSEIF WA_ZMCHB-MATNR EQ '000000000000100110'.
        CED2 = 1000.
      ELSE.
        CED2 = 100.
      ENDIF.
      WA_POT1-COUNT = WA_MAT1-COUNT.
      WA_POT1-MATNR = WA_MAT1-MATNR.
      WA_POT1-POTX1 = WA_MAT1-POTX1.
******************************************************************************************
*      ON CHANGE OF WA_ZMCHB-MATNR.
*        break-point.
      CLEAR : NPOT1,NPOT2,S3,NSTOCK1.
      READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
      IF SY-SUBRC EQ 0.
        SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
        IF SY-SUBRC EQ 0.
          NPOT1 = ZINSPPOT-UPOT.
        ENDIF.
      ENDIF.
      IF NPOT1 IS INITIAL.
        CLEAR : PVAL1.
        SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
        IF SY-SUBRC EQ 0.
          SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
          IF SY-SUBRC EQ 0.
            PVAL1 = QAMR-ORIGINAL_INPUT.
            CONDENSE PVAL1.
            NPOT1 = PVAL1.
          ENDIF.
        ENDIF.
      ENDIF.

      NPOT2 = NPOT1.

      IF OP3 GT CED2.
        OP3 = CED2.
      ENDIF.
      IF NPOT2 GT CED2.
        NPOT2 = CED2.
      ENDIF.
      IF CHK1 EQ 1.
        NSTOCK1 = ( STOCK * OP3 / NPOT2 ).
      ELSE.
*        IF  NPOT2 GT 0 AND NPOT2 LT 100.
        IF  NPOT2 GT 0 AND NPOT2 LT CED2.
*          NSTOCK1 = ( STOCK * 100 ) / NPOT2.
          NSTOCK1 = ( STOCK * CED2 ) / NPOT2.
          IF NSTOCK1 GT WA_ZMCHB-CLABS AND STOCK LT WA_ZMCHB-CLABS.  "23.7.23
            STOCK = NSTOCK1.
            S3 = 1.
          ENDIF.
        ELSE.
          NSTOCK1 = STOCK.
        ENDIF.
      ENDIF.



      IF WA_ZMCHB-CLABS GE NSTOCK1.
        IF CHK1 GT 0.
          WA_POT1-CHARG = WA_ZMCHB-CHARG.
          WA_POT1-STOCK = STOCK.
          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
          IF SY-SUBRC EQ 0.
            WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
            CLEAR : P1,P2,P3.
            SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
            IF SY-SUBRC EQ 0.
              P3 = ZINSPPOT-UPOT.
              WA_POT1-P3 = P3.
            ENDIF.

            IF P3 LE 0.
              CLEAR : PVAL1.
              SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
              IF SY-SUBRC EQ 0.
                SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
                IF SY-SUBRC EQ 0.
                  PVAL1 = QAMR-ORIGINAL_INPUT.
                  CONDENSE PVAL1.
                  P3 = PVAL1.
                ENDIF.
              ENDIF.
              WA_POT1-P3 = P3.
            ENDIF.
            IF OP3 GT CED2.
              OP3 = CED2.
            ENDIF.
            IF P3 GT CED2.
              P3 = CED2.
            ENDIF.
            CLEAR : NQTY1,NQTY11.
            NQTY1 = STOCK * OP3 / P3.
            NQTY11 = STOCK * OP3 / P3.
            WA_POT1-NQTY1 = NQTY1.
            WA_POT1-DQTY = NQTY1.
            WA_POT1-NQTY11 = NQTY11.
            WA_POT1-DQTY11 = NQTY11.
          ENDIF.
        ELSE.

          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
          IF SY-SUBRC EQ 0.
            WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
            CLEAR : P1,P2,P3.
            SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
            IF SY-SUBRC EQ 0.
              P3 = ZINSPPOT-UPOT.
              WA_POT1-P3 = P3.
            ENDIF.
            IF P3 LE 0.
              CLEAR : PVAL1.
              SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
              IF SY-SUBRC EQ 0.
                SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
                IF SY-SUBRC EQ 0.
                  PVAL1 = QAMR-ORIGINAL_INPUT.
                  CONDENSE PVAL1.
                  P3 = PVAL1.
                ENDIF.
              ENDIF.
              WA_POT1-P3 = P3.
            ENDIF.
          ENDIF.
          WA_POT1-CHARG = WA_ZMCHB-CHARG.
*          WA_POT1-STOCK = STOCK.
*          wa_pot1-stock = wa_mat1-menge.
          WA_POT1-STOCK = WA_MAT1-MENGE1. "changes on 3.9.25
          CLEAR : QTY1,QTY11.
*          IF NPOT2 GT 100.
          WA_POT1-P3 = P3.
          IF P3 GT CED2.
            P3 = CED2.
          ENDIF.
          IF NPOT2 GT CED2.
*            QTY1 = STOCK.
            QTY1 = WA_MAT1-MENGE.
            QTY11 = WA_MAT1-MENGE.
          ELSE.
*            QTY1 = STOCK * 100 / NPOT2.
*            QTY1 = STOCK * 100 / P3.
*            QTY1 = WA_MAT1-MENGE * 100 / P3.
*            qty1 = wa_mat1-menge * ced2 / p3.
*            qty11 = wa_mat1-menge * ced2 / p3.
            IF P3 NE 0.                         "Added by Vinayak S. to remove divide by 0 dump
              QTY1 = WA_MAT1-MENGE1 * CED2 / P3.
              QTY11 = WA_MAT1-MENGE1 * CED2 / P3.
            ENDIF.
          ENDIF.
          WA_POT1-NQTY1 = QTY1.
          WA_POT1-DQTY = QTY1.
          WA_POT1-NQTY11 = QTY11.
          WA_POT1-DQTY11 = QTY11.
*          wa_pot1-p3 = npot2.
*          WA_POT1-P3 = P3.

        ENDIF.

        WA_ZMCHB-CLABS = WA_ZMCHB-CLABS - STOCK.
        MODIFY IT_ZMCHB FROM WA_ZMCHB TRANSPORTING CLABS WHERE MATNR = WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.
        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
        EXIT.
      ELSE.

*************************if stock is less************
        CHK1 = 1.
        NC1 = NC1 + 1.
        WA_POT1-CHARG = WA_ZMCHB-CHARG.
        IF NC1 GT 1.
          WA_POT1-STOCK = STOCK2.
        ELSE.
          WA_POT1-STOCK = WA_ZMCHB-CLABS.
        ENDIF.
        IF NC1 GT 1.
*          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
*          IF SY-SUBRC EQ 0.
*            P3 = ZINSPPOT-UPOT.
*          ENDIF.
*********************new code 4.4.25***************
          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
          IF SY-SUBRC EQ 0.
            CLEAR : PVAL4.
            SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
            IF SY-SUBRC EQ 0.
              SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
              IF SY-SUBRC EQ 0.
                PVAL4 = QAMR-ORIGINAL_INPUT.
                CONDENSE PVAL4.
                P3 = PVAL4.
              ENDIF.
            ENDIF.
          ENDIF.
********************************************************************
          IF OP3 GT CED2.
            OP3 = CED2.
          ENDIF.
          IF P3 GT CED2.
            P3 = CED2.
          ENDIF.
          WA_POT1-NQTY1 = WA_POT1-STOCK * ( OP3 / P3 ).
          WA_POT1-NQTY11 = WA_POT1-STOCK * ( OP3 / P3 ).
        ELSE.
          WA_POT1-NQTY1 = NSTOCK1.
          WA_POT1-NQTY11 = NSTOCK1.
        ENDIF.
        WA_POT1-DQTY = WA_ZMCHB-CLABS.
        WA_POT1-DQTY11 = WA_ZMCHB-CLABS.
        READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
        IF SY-SUBRC EQ 0.
          WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
          CLEAR : P1,P2,P3,OP3.
          SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
          IF SY-SUBRC EQ 0.
            P3 = ZINSPPOT-UPOT.
            WA_POT1-P3 = P3.
            OP3 = P3.
          ENDIF.

          IF P3 LE 0.
            CLEAR : PVAL1.
            SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
            IF SY-SUBRC EQ 0.
              SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
              IF SY-SUBRC EQ 0.
                PVAL1 = QAMR-ORIGINAL_INPUT.
                CONDENSE PVAL1.
                P3 = PVAL1.
              ENDIF.
            ENDIF.
            WA_POT1-P3 = P3.
            OP3 = P3.
          ENDIF.

          STOCK2 = WA_POT1-NQTY1 - WA_POT1-DQTY.
        ENDIF.
        IF THREED EQ 1.
          STOCK = WA_POT1-NQTY11 - WA_POT1-DQTY11.
        ELSE.
          STOCK = WA_POT1-NQTY1 - WA_POT1-DQTY.
        ENDIF.
        IF THREED EQ 1.
          WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY1.
        ELSE.
          WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY.
        ENDIF.
        MODIFY IT_MAT1 FROM WA_MAT1 TRANSPORTING MENGE WHERE MATNR EQ WA_MAT1-MATNR.  "check1
        DELETE IT_ZMCHB WHERE MATNR EQ WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.
        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
      ENDIF.
    ENDLOOP.

*******************************************************************************
    FORMAT COLOR 3.
    CLEAR : ESTOCK.
    ESTOCK = STOCK2 - WA_MAT1-MENGE.
*    WRITE : / 'ACTUAL STOCK',WA_MAT1-MENGE,'dispenced stock',STOCK2,'EXCESS',ESTOCK.
*    WRITE : / 'DISPENCED STOCK: ',STOCK2 LEFT-JUSTIFIED,'  EXCESS',ESTOCK LEFT-JUSTIFIED.
    WA_POS1-STOCK2 = STOCK2.
    WA_POS1-ESTOCK = ESTOCK.
    WA_POS1-ADJMATNR = WA_MAT1-ADJMATNR.
    WA_POS1-COUNT = WA_MAT1-COUNT.
    FORMAT COLOR 4.
    CLEAR : STOCK.
    ASTOCK = WA_MAT1-ADJMENGE - ESTOCK.
*    SKIP.
    IF COMP EQ 1.
*      FORMAT COLOR 7.
*      WRITE : / 'CALCULATION FOR :'.
      CLEAR : AMAKTX1,AMAKTX2,AMAKTX,ANORMT.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX1 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX2 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        ANORMT = MARA-NORMT.
      ENDIF.
      CONCATENATE AMAKTX1 AMAKTX2 ANORMT INTO AMAKTX SEPARATED BY SPACE.
      CONDENSE AMAKTX.
*      WRITE : AMAKTX.
      WA_POS1-AMAKTX = AMAKTX.

*    WA_MAT1-ADJMATNR,WA_MAT1-ADJMENGE,'NEW STOCK',ASTOCK.
      TQTY1 = 0.
      TQTY2 = 0.
*      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(' WA_MAT1-MEINS ')' INTO BMAKTX SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(kg)' INTO BMAKTX SEPARATED BY SPACE.
      CONDENSE BMAKTX.
      CLEAR : AQTY1.
      AQTY1 = WA_MAT1-MENGE1 + WA_MAT1-ADJMENGE.
      CLEAR : BMAKTX1.
*      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(' WA_MAT1-MEINS ')' INTO BMAKTX1 SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(kg)' INTO BMAKTX1 SEPARATED BY SPACE.
      CONDENSE BMAKTX1.
      CLEAR : BMAKTX2.
*      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(' WA_MAT1-ADJMEINS ')' INTO BMAKTX2 SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(kg)' INTO BMAKTX2 SEPARATED BY SPACE.
      CONDENSE BMAKTX2.
      CLEAR : ADJQTY,ADJQTY1.
      IF THREED EQ 1.
        ADJQTY1 =  AQTY1 - STOCK2.
        ADJQTY =  AQTY1 - STOCK2.
      ELSE.
        ADJQTY =  AQTY1 - STOCK2.
      ENDIF.
*      WRITE : / BMAKTX, 60 BMAKTX1,120 BMAKTX2.
*      WRITE : / AQTY1, 60 STOCK2,120 ADJQTY.
      WA_POS1-BMAKTX = BMAKTX.
      WA_POS1-BMAKTX1 = BMAKTX1.
      WA_POS1-BMAKTX2 = BMAKTX2.

      WA_POS1-AQTY1 = AQTY1.

      WA_POS1-STOCK2 = STOCK2.
      IF THREED EQ 1.
        WA_POS1-ADJQTY = ADJQTY1.
      ELSE.
        WA_POS1-ADJQTY = ADJQTY.
      ENDIF.
*      ULINE.
*      SKIP.
    ENDIF.
    COLLECT WA_POS1 INTO IT_POS1.
    CLEAR WA_POS1.
  ENDLOOP.
*  ULINE.
*  LOOP AT IT_MCHB INTO WA_MCHB.
*    WRITE : / 'CUR  STOCK',WA_MCHB-MATNR,WA_MCHB-CHARG,WA_MCHB-CLABS.
*  ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GPOTENCY
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM GPOTENCY .
  READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
  IF SY-SUBRC EQ 0.
*    WRITE : 30  WA_QALS-PRUEFLOS.
    WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
    CLEAR : P1,P2,P3.
    SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    IF SY-SUBRC EQ 0.
      P3 = ZINSPPOT-UPOT.
*      TEXT = ZINSPPOT-SGTXT.
      WA_POT1-P3 = P3.
      CONDENSE WA_POT1-P3.
*      WA_POT1-TEXT = TEXT.
    ENDIF.

    IF P3 LE 0.
      CLEAR : PVAL1.
      SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
      IF SY-SUBRC EQ 0.
        SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
        IF SY-SUBRC EQ 0.
          PVAL1 = QAMR-ORIGINAL_INPUT.
          CONDENSE PVAL1.
          P3 = PVAL1.
        ENDIF.
      ENDIF.
      WA_POT1-P3 = P3.
      CONDENSE WA_POT1-P3.
    ENDIF.



    WA_POT1-NQTY1 = NSTOCK1.
    WA_POT1-DQTY = WA_ZMCHB-CLABS.
*    PERFORM GPOT1.
*    CLEAR : NQTY1.
*    NQTY1 = NSTOCK1 * NPOT1 / P3.

    CLEAR : QTY1.
    QTY1 = NSTOCK1 - WA_ZMCHB-CLABS.
    NSTOCK1 = QTY1.
    NPOT1 = P3.
*WA_POT1-NQTY1 = NQTY1.
*WA_POT1-DQTY = NQTY1.
    TQTY1 = TQTY1 + QTY1.

  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  ASTOCK_G
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM ASTOCK_G .

  SORT IT_MCHB BY MATNR WERKS CHARG.
  DELETE IT_MCHB WHERE CLABS EQ 0.
  IF IT_MCHB IS NOT INITIAL.
    SELECT * FROM QALS INTO TABLE IT_QALS FOR ALL ENTRIES IN IT_MCHB WHERE MATNR EQ IT_MCHB-MATNR AND WERK EQ IT_MCHB-WERKS AND CHARG EQ IT_MCHB-CHARG.
  ENDIF.

  SORT IT_QALS DESCENDING BY ENSTEHDAT.

  LOOP AT IT_QALS INTO WA_QALS.
    SELECT SINGLE * FROM JEST WHERE OBJNR EQ WA_QALS-OBJNR AND STAT EQ 'I0224'.
    IF SY-SUBRC EQ 0.
      DELETE IT_QALS WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
    ENDIF.
  ENDLOOP.
*  FORMAT COLOR 2.

  LOOP AT IT_MCHB INTO WA_MCHB.
    WA_ZMCHB-MATNR = WA_MCHB-MATNR.
    WA_ZMCHB-WERKS = WA_MCHB-WERKS.
    WA_ZMCHB-LGORT = WA_MCHB-LGORT.
    WA_ZMCHB-CHARG = WA_MCHB-CHARG.
    WA_ZMCHB-CLABS = WA_MCHB-CLABS.
    SELECT SINGLE * FROM MCHA WHERE MATNR EQ WA_MCHB-MATNR AND WERKS EQ WA_MCHB-WERKS AND CHARG EQ WA_MCHB-CHARG.
    IF SY-SUBRC EQ 0.
      IF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR1.  "FOLLOW FIFO in insue-material exist.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR2.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR3.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR4.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR5.
      ELSEIF FIFO EQ 'X' AND WA_MCHB-MATNR EQ FMATNR6.
      ELSE.
        WA_ZMCHB-VFDAT = MCHA-VFDAT.
      ENDIF.
*      WA_ZMCHB-VFDAT = MCHA-VFDAT.
      WA_ZMCHB-LWEDT = MCHA-LWEDT.
    ENDIF.

    COLLECT WA_ZMCHB INTO IT_ZMCHB.
    CLEAR WA_ZMCHB.
    CLEAR WA_MCHB.
  ENDLOOP.
  SORT IT_ZMCHB BY MATNR VFDAT LWEDT.

  LOOP AT IT_MAT1 INTO WA_MAT1.

*    FORMAT COLOR 5.
*    WRITE : / WA_MAT1-MATNR,WA_MAT1-POTX1.

    CLEAR : MAKTX1,MAKTX2,MAKTX,NORMT.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX1 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      MAKTX2 = MAKT-MAKTX.
    ENDIF.
    SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-MATNR.
    IF SY-SUBRC EQ 0.
      NORMT = MARA-NORMT.
    ENDIF.
    CONCATENATE MAKTX1 MAKTX2 NORMT INTO MAKTX SEPARATED BY SPACE.
    CONDENSE MAKTX.
*    WRITE : / 'Potency calculation for',MAKTX.
    CLEAR : MAKTX4,MQTY1.
    MQTY1 = WA_MAT1-MENGE.
    CONDENSE MQTY1.
*    CONCATENATE 'Theoritical qty of ' MAKTX 'per lot = ' MQTY1 WA_MAT1-MEINS 'as 100% on as such basis' INTO MAKTX4
    CONCATENATE 'THEORITICAL QTY OF ' MAKTX 'PER LOT = ' MQTY1 WA_MAT1-MEINS INTO MAKTX4  SEPARATED BY SPACE.
*    'AS 100% ON ' TEXT


*    WRITE : / MAKTX4.
    TQTY1 = 0.
    TQTY2 = 0.
    CLEAR : STOCK.
*    STOCK = WA_MAT1-MENGE.
    STOCK = WA_MAT1-MENGE1.
*    FORMAT COLOR 3.
    CLEAR : STOCK2.
*    WRITE : /1 'BATCH',15 'AVAILABLE QTY', 30 'INSPECTION LOT', 50 'POTENCY', 60 'QTY AS PER ASSAY'.
*    ,80 'DISPENSED QTY'.
*    BREAK-POINT .
    CLEAR : STOCK2.
    CLEAR :NC1.
    CLEAR : CHK1.
    LOOP AT IT_ZMCHB INTO WA_ZMCHB WHERE MATNR = WA_MAT1-MATNR.
*      BREAK-POINT .

      CLEAR : THREED.
      SELECT SINGLE * FROM ZPOTENCY_API WHERE IDNRK EQ WA_ZMCHB-MATNR.
      IF SY-SUBRC EQ 0.
        THREED = 1.  "for 3 decimal.
      ENDIF.

      CLEAR : CED2.
      IF WA_ZMCHB-MATNR EQ '000000000000100693'.
        CED2 = 700.
      ELSEIF WA_ZMCHB-MATNR EQ '000000000000100110'.
        CED2 = 1000.
      ELSE.
        CED2 = 100.
      ENDIF.
      WA_POT1-COUNT = WA_MAT1-COUNT.
      WA_POT1-MATNR = WA_MAT1-MATNR.
      WA_POT1-POTX1 = WA_MAT1-POTX1.
******************************************************************************************
*      ON CHANGE OF WA_ZMCHB-MATNR.
*        break-point.
      CLEAR : NPOT1,NPOT2,S3,NSTOCK1.
      READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
      IF SY-SUBRC EQ 0.
        SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
        IF SY-SUBRC EQ 0.
          NPOT1 = ZINSPPOT-UPOT.
        ENDIF.
      ENDIF.
      IF NPOT1 IS INITIAL.
        CLEAR : PVAL1.
        SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
        IF SY-SUBRC EQ 0.
          SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
          IF SY-SUBRC EQ 0.
            PVAL1 = QAMR-ORIGINAL_INPUT.
            CONDENSE PVAL1.
            NPOT1 = PVAL1.
          ENDIF.
        ENDIF.
      ENDIF.

      NPOT2 = NPOT1.
      IF CHK1 EQ 1.
*        if npot2 ge ced2.
*          nstock1 = stock.
*        else.
*          nstock1 = ( stock * op3 / npot2 ).
*        endif.
*        *added on 1.6.25
        CLEAR : NNPOT2,NOP3.
        IF NPOT2 GT CED2.
          NNPOT2 = CED2.
        ELSE.
          NNPOT2 = NPOT2.
        ENDIF.
        IF OP3 GT CED2.
          NOP3 = CED2.
        ELSE.
          NOP3 = OP3.
        ENDIF.
        NSTOCK1 = ( STOCK * NOP3 / NNPOT2 ).
      ELSE.
*        IF  NPOT2 GT 0 AND NPOT2 LT 100.
        IF  NPOT2 GT 0 AND NPOT2 LT CED2.
*          NSTOCK1 = ( STOCK * 100 ) / NPOT2.
          NSTOCK1 = ( STOCK * CED2 ) / NPOT2.
          IF NSTOCK1 GT WA_ZMCHB-CLABS AND STOCK LT WA_ZMCHB-CLABS.  "23.7.23
            STOCK = NSTOCK1.
            S3 = 1.
          ENDIF.
        ELSE.
          NSTOCK1 = STOCK.
        ENDIF.

      ENDIF.
******************************************** changes made on 26.11.24**************
*      IF NSTOCK1 GT STOCK.
*        STOCK = NSTOCK1.
*      ENDIF.


      IF WA_ZMCHB-CLABS GE NSTOCK1.
        IF CHK1 GT 0.
          WA_POT1-CHARG = WA_ZMCHB-CHARG.
          WA_POT1-STOCK = STOCK.
          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
          IF SY-SUBRC EQ 0.
            WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
            CLEAR : P1,P2,P3.
            SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
            IF SY-SUBRC EQ 0.
              P3 = ZINSPPOT-UPOT.
              WA_POT1-P3 = P3.
            ENDIF.

            IF P3 LE 0.
              CLEAR : PVAL1.
              SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
              IF SY-SUBRC EQ 0.
                SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
                IF SY-SUBRC EQ 0.
                  PVAL1 = QAMR-ORIGINAL_INPUT.
                  CONDENSE PVAL1.
                  P3 = PVAL1.
                ENDIF.
              ENDIF.
              WA_POT1-P3 = P3.
            ENDIF.

            CLEAR : NQTY1,NQTY11.
*            if p3 ge ced2.
*              nqty1 = stock.
*              nqty11 = stock .
*            else.
*              nqty1 = stock * op3 / p3.
*              nqty11 = stock * op3 / p3.
*            endif.
******addded on 1.6.25***
            CLEAR : NP3,NOP3.
            IF P3 GT CED2.
              NP3 = CED2.
            ELSE.
              NP3 = P3.
            ENDIF.
            IF OP3 GT CED2.
              NOP3 = CED2.
            ELSE.
              NOP3 = OP3.
            ENDIF.
            NQTY1 = STOCK * NOP3 / NP3.
            NQTY11 = STOCK * NOP3 / NP3.

            WA_POT1-NQTY1 = NQTY1.
            WA_POT1-DQTY = NQTY1.
            WA_POT1-NQTY11 = NQTY11.
            WA_POT1-DQTY11 = NQTY11.
          ENDIF.
        ELSE.

          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
          IF SY-SUBRC EQ 0.
            WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
            CLEAR : P1,P2,P3.
            SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
            IF SY-SUBRC EQ 0.
              P3 = ZINSPPOT-UPOT.
              WA_POT1-P3 = P3.
            ENDIF.
            IF P3 LE 0.
              CLEAR : PVAL1.
              SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
              IF SY-SUBRC EQ 0.
                SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
                IF SY-SUBRC EQ 0.
                  PVAL1 = QAMR-ORIGINAL_INPUT.
                  CONDENSE PVAL1.
                  P3 = PVAL1.
                ENDIF.
              ENDIF.
              WA_POT1-P3 = P3.
            ENDIF.
          ENDIF.
          WA_POT1-CHARG = WA_ZMCHB-CHARG.
*          WA_POT1-STOCK = STOCK.
          WA_POT1-STOCK = WA_MAT1-MENGE.
          CLEAR : QTY1,QTY11.
*          IF NPOT2 GT 100.
*          if npot2 gt ced2.
*
**            QTY1 = STOCK.
*            qty1 = wa_mat1-menge.
*            qty11 = wa_mat1-menge.
*          else.
**            QTY1 = STOCK * 100 / NPOT2.
**            QTY1 = STOCK * 100 / P3.
**            QTY1 = WA_MAT1-MENGE * 100 / P3.
*            qty1 = wa_mat1-menge * ced2 / p3.
*            qty11 = wa_mat1-menge * ced2 / p3.
*          endif.

**********added on 1.6.25***
          CLEAR : NP3.
          IF P3 GT CED2.
            NP3 = CED2.
          ELSE.
            NP3 = P3.
          ENDIF.
          IF NP3 NE 0.                    "Added by Vinayak S. remove divide by 0 dump
            QTY1 = WA_MAT1-MENGE * CED2 / NP3.
            QTY11 = WA_MAT1-MENGE * CED2 / NP3.
          ENDIF.

          WA_POT1-NQTY1 = QTY1.
          WA_POT1-DQTY = QTY1.
          WA_POT1-NQTY11 = QTY11.
          WA_POT1-DQTY11 = QTY11.
*          wa_pot1-p3 = npot2.
          WA_POT1-P3 = P3.

        ENDIF.
        CONDENSE WA_POT1-P3.
        IF NSTOCK1 GT STOCK.  "added on 16.4.25
          WA_ZMCHB-CLABS = WA_ZMCHB-CLABS - NSTOCK1.
        ELSE.
          WA_ZMCHB-CLABS = WA_ZMCHB-CLABS - STOCK.
        ENDIF.
        MODIFY IT_ZMCHB FROM WA_ZMCHB TRANSPORTING CLABS WHERE MATNR = WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.
        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
        EXIT.
      ELSE.

*************************if stock is less************
        CHK1 = 1.
        NC1 = NC1 + 1.
        WA_POT1-CHARG = WA_ZMCHB-CHARG.
        IF NC1 GT 1.
          WA_POT1-STOCK = STOCK2.
        ELSE.
          WA_POT1-STOCK = WA_ZMCHB-CLABS.
        ENDIF.
        IF NC1 GT 1.
          READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
          IF SY-SUBRC EQ 0.
            P3 = ZINSPPOT-UPOT.
          ENDIF.
          CLEAR : NP3,NOP3.
          IF P3 GT CED2.
            NP3 = CED2.
          ELSE.
            NP3 = P3.
          ENDIF.
          IF OP3 GT CED2.
            NOP3 = CED2.
          ELSE.
            NOP3 = OP3.
          ENDIF.

*          wa_pot1-nqty1 = wa_pot1-stock * ( op3 / p3 ).
*          wa_pot1-nqty11 = wa_pot1-stock * ( op3 / p3 ).
          WA_POT1-NQTY1 = WA_POT1-STOCK * ( NOP3 / NP3 ).
          WA_POT1-NQTY11 = WA_POT1-STOCK * ( NOP3 / NP3 ).
        ELSE.
          WA_POT1-NQTY1 = NSTOCK1.
          WA_POT1-NQTY11 = NSTOCK1.
        ENDIF.
        WA_POT1-DQTY = WA_ZMCHB-CLABS.
        WA_POT1-DQTY11 = WA_ZMCHB-CLABS.
        READ TABLE IT_QALS INTO WA_QALS WITH KEY MATNR = WA_ZMCHB-MATNR CHARG = WA_ZMCHB-CHARG WERK = WA_ZMCHB-WERKS.
        IF SY-SUBRC EQ 0.
          WA_POT1-PRUEFLOS = WA_QALS-PRUEFLOS.
          CLEAR : P1,P2,P3,OP3.
          SELECT SINGLE * FROM ZINSPPOT WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS.
          IF SY-SUBRC EQ 0.
            P3 = ZINSPPOT-UPOT.
            WA_POT1-P3 = P3.
            OP3 = P3.
          ENDIF.

          IF P3 LE 0.
            CLEAR : PVAL1.
            SELECT SINGLE * FROM QAMV WHERE PRUEFLOS EQ WA_QALS-PRUEFLOS AND VERWMERKM EQ 'POTENCY1'.
            IF SY-SUBRC EQ 0.
              SELECT SINGLE * FROM QAMR WHERE PRUEFLOS EQ QAMV-PRUEFLOS AND MERKNR EQ QAMV-MERKNR.
              IF SY-SUBRC EQ 0.
                PVAL1 = QAMR-ORIGINAL_INPUT.
                CONDENSE PVAL1.
                P3 = PVAL1.
              ENDIF.
            ENDIF.
            WA_POT1-P3 = P3.
            OP3 = P3.
          ENDIF.

          STOCK2 = WA_POT1-NQTY1 - WA_POT1-DQTY.
        ENDIF.
        IF THREED EQ 1.
          STOCK = WA_POT1-NQTY11 - WA_POT1-DQTY11.
        ELSE.
          STOCK = WA_POT1-NQTY1 - WA_POT1-DQTY.
        ENDIF.
        IF THREED EQ 1.
          WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY1.
        ELSE.
          WA_MAT1-MENGE = WA_MAT1-MENGE - WA_ZMCHB-CLABS + RQTY.
        ENDIF.
        CONDENSE WA_POT1-P3.

        MODIFY IT_MAT1 FROM WA_MAT1 TRANSPORTING MENGE WHERE MATNR EQ WA_MCHB-MATNR.
        DELETE IT_ZMCHB WHERE MATNR EQ WA_MAT1-MATNR AND CHARG = WA_ZMCHB-CHARG AND LGORT EQ WA_ZMCHB-LGORT AND WERKS EQ PLANT.
        DELETE IT_ZMCHB WHERE CLABS EQ 0.
        COLLECT WA_POT1 INTO IT_POT1.
        CLEAR WA_POT1.
      ENDIF.
    ENDLOOP.

*******************************************************************************
    FORMAT COLOR 3.
    CLEAR : ESTOCK.
    ESTOCK = STOCK2 - WA_MAT1-MENGE.
*    WRITE : / 'ACTUAL STOCK',WA_MAT1-MENGE,'dispenced stock',STOCK2,'EXCESS',ESTOCK.
*    WRITE : / 'DISPENCED STOCK: ',STOCK2 LEFT-JUSTIFIED,'  EXCESS',ESTOCK LEFT-JUSTIFIED.
    WA_POS1-STOCK2 = STOCK2.
    WA_POS1-ESTOCK = ESTOCK.
    WA_POS1-ADJMATNR = WA_MAT1-ADJMATNR.
    WA_POS1-COUNT = WA_MAT1-COUNT.
    FORMAT COLOR 4.
    CLEAR : STOCK.
    ASTOCK = WA_MAT1-ADJMENGE - ESTOCK.
*    SKIP.
    IF COMP EQ 1.
*      FORMAT COLOR 7.
*      WRITE : / 'CALCULATION FOR :'.
      CLEAR : AMAKTX1,AMAKTX2,AMAKTX,ANORMT.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'EN' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX1 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MAKT WHERE SPRAS EQ 'Z1' AND MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        AMAKTX2 = MAKT-MAKTX.
      ENDIF.
      SELECT SINGLE * FROM MARA WHERE MATNR EQ WA_MAT1-ADJMATNR.
      IF SY-SUBRC EQ 0.
        ANORMT = MARA-NORMT.
      ENDIF.
      CONCATENATE AMAKTX1 AMAKTX2 ANORMT INTO AMAKTX SEPARATED BY SPACE.
      CONDENSE AMAKTX.
*      WRITE : AMAKTX.
      WA_POS1-AMAKTX = AMAKTX.

*    WA_MAT1-ADJMATNR,WA_MAT1-ADJMENGE,'NEW STOCK',ASTOCK.
      TQTY1 = 0.
      TQTY2 = 0.
*      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(' WA_MAT1-MEINS ')' INTO BMAKTX SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' MAKTX '+' AMAKTX '(kg)' INTO BMAKTX SEPARATED BY SPACE.
      CONDENSE BMAKTX.
      CLEAR : AQTY1.
      AQTY1 = WA_MAT1-MENGE1 + WA_MAT1-ADJMENGE.
      CLEAR : BMAKTX1.
*      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(' WA_MAT1-MEINS ')' INTO BMAKTX1 SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' MAKTX 'dispenced' '(kg)' INTO BMAKTX1 SEPARATED BY SPACE.
      CONDENSE BMAKTX1.
      CLEAR : BMAKTX2.
*      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(' WA_MAT1-ADJMEINS ')' INTO BMAKTX2 SEPARATED BY SPACE.
      CONCATENATE 'Qty of ' AMAKTX 'dispenced' '(kg)' INTO BMAKTX2 SEPARATED BY SPACE.
      CONDENSE BMAKTX2.
      CLEAR : ADJQTY,ADJQTY1.
      IF THREED EQ 1.
        ADJQTY1 =  AQTY1 - STOCK2.
        ADJQTY =  AQTY1 - STOCK2.
      ELSE.
        ADJQTY =  AQTY1 - STOCK2.
      ENDIF.
*      WRITE : / BMAKTX, 60 BMAKTX1,120 BMAKTX2.
*      WRITE : / AQTY1, 60 STOCK2,120 ADJQTY.
      WA_POS1-BMAKTX = BMAKTX.
      WA_POS1-BMAKTX1 = BMAKTX1.
      WA_POS1-BMAKTX2 = BMAKTX2.

      WA_POS1-AQTY1 = AQTY1.

      WA_POS1-STOCK2 = STOCK2.
      IF THREED EQ 1.
        WA_POS1-ADJQTY = ADJQTY1.
      ELSE.
        WA_POS1-ADJQTY = ADJQTY.
      ENDIF.
*      ULINE.
*      SKIP.
    ENDIF.
    COLLECT WA_POS1 INTO IT_POS1.
    CLEAR WA_POS1.
  ENDLOOP.

ENDFORM.



FORM UPDATE_POT2.

  REFRESH : IT_POT2.
  CLEAR : WA_POT2, POTQTY11, POTQTY12, PADJMENGE, ADJMATNR, AAQTY1, AAQTY2, AAQTY3 .

  SELECT * FROM AFPO INTO TABLE @DATA(IT_AFPO) WHERE MATNR = @MATNR AND CHARG = @BATCH.
  IF SY-SUBRC EQ 0.

    CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT'
      EXPORTING
        INPUT          = 'KAI'
        LANGUAGE       = SY-LANGU
      IMPORTING
        OUTPUT         = LV_ERFME
      EXCEPTIONS
        UNIT_NOT_FOUND = 1
        OTHERS         = 2.
    IF SY-SUBRC <> 0.
* Implement suitable error handling here
    ENDIF.


    SELECT * FROM RESB INTO TABLE @DATA(IT_RESB1)
      FOR ALL ENTRIES IN @IT_AFPO
      WHERE AUFNR = @IT_AFPO-AUFNR
      AND ERFME = @LV_ERFME
      AND CHARG NE @SPACE
      AND POSNR = @WA_MAT1-POSNR
      AND MATNR = @WA_MAT1-MATNR.

    SELECT AUFNR, STLNR, STLAL FROM AFKO INTO TABLE @DATA(IT_AFKO) FOR ALL ENTRIES IN @IT_AFPO WHERE AUFNR = @IT_AFPO-AUFNR.
    IF SY-SUBRC EQ 0.

      SELECT STLKN, STLNR, STLAL FROM STAS INTO TABLE @DATA(IT_STAS) FOR ALL ENTRIES IN @IT_AFKO WHERE STLNR = @IT_AFKO-STLNR AND STLAL = @IT_AFKO-STLAL.
      IF SY-SUBRC EQ 0.

        READ TABLE IT_RESB1 INTO WA_RESB INDEX 1.
        IF SY-SUBRC EQ 0.

          SELECT IDNRK, MENGE, STLKN, STLNR, POSNR
            FROM STPO INTO TABLE @DATA(IT_STPO)
            FOR ALL ENTRIES IN @IT_STAS
            WHERE STLNR = @IT_STAS-STLNR
            AND STLKN = @IT_STAS-STLKN
            AND POSNR = @WA_RESB-SORTF.

          IF SY-SUBRC EQ 0.

            READ TABLE IT_STPO INTO DATA(WA_STPO) INDEX 1.
            IF SY-SUBRC EQ 0.
              SELECT SINGLE MAKTX FROM MAKT INTO @DATA(LV_MAKTX) WHERE MATNR = @WA_STPO-IDNRK AND SPRAS = 'E'.
            ENDIF.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDIF.

    IF IT_RESB1 IS NOT INITIAL.
      SELECT * FROM QALS INTO TABLE @DATA(IT_QALS1) FOR ALL ENTRIES IN @IT_RESB1 WHERE CHARG = @IT_RESB1-CHARG AND MATNR = @IT_RESB1-MATNR.

      SELECT CUOBJ_BM, MATNR, CHARG FROM MCH1 INTO TABLE @IT_MCH1 FOR ALL ENTRIES IN @IT_RESB1 WHERE MATNR = @IT_RESB1-MATNR AND CHARG = @IT_RESB1-CHARG.

      IF SY-SUBRC EQ 0.

        CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
          EXPORTING
            INPUT  = 'ZPOTENCY'
          IMPORTING
            OUTPUT = LV_ATINN.

        IF SY-SUBRC EQ 0.
          CLEAR LR_ATINN.
          LR_ATINN-SIGN = 'I'.        "Include
          LR_ATINN-OPTION = 'EQ'.     "Equal to
          LR_ATINN-LOW = LV_ATINN.    "Material number
          APPEND LR_ATINN.
        ENDIF.


*      IF sy-subrc NE 0.
        CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
          EXPORTING
            INPUT  = 'ZPOTENCY1'
          IMPORTING
            OUTPUT = LV_ATINN.

        IF SY-SUBRC EQ 0.
          CLEAR LR_ATINN.
          LR_ATINN-SIGN = 'I'.        "Include
          LR_ATINN-OPTION = 'EQ'.     "Equal to
          LR_ATINN-LOW = LV_ATINN.    "Material number
          APPEND LR_ATINN.
        ENDIF.

*      IF sy-subrc NE 0.
        CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
          EXPORTING
            INPUT  = 'ZPOTENCY2'
          IMPORTING
            OUTPUT = LV_ATINN.
        IF SY-SUBRC EQ 0.
          CLEAR LR_ATINN.
          LR_ATINN-SIGN = 'I'.        "Include
          LR_ATINN-OPTION = 'EQ'.     "Equal to
          LR_ATINN-LOW = LV_ATINN.    "Material number
          APPEND LR_ATINN.
        ENDIF.


        CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
          EXPORTING
            INPUT  = 'ZPOTENCY3'
          IMPORTING
            OUTPUT = LV_ATINN.
        IF SY-SUBRC EQ 0.
          CLEAR LR_ATINN.

          LR_ATINN-SIGN = 'I'.        "Include
          LR_ATINN-OPTION = 'EQ'.     "Equal to
          LR_ATINN-LOW = LV_ATINN.    "Material number
          APPEND LR_ATINN.
        ENDIF.


        CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
          EXPORTING
            INPUT  = 'ZPOTENCY4'
          IMPORTING
            OUTPUT = LV_ATINN.
        IF SY-SUBRC EQ 0.
          CLEAR LR_ATINN.
          LR_ATINN-SIGN = 'I'.        "Include
          LR_ATINN-OPTION = 'EQ'.     "Equal to
          LR_ATINN-LOW = LV_ATINN.    "Material number
          APPEND LR_ATINN.
        ENDIF.
        SELECT * FROM AUSP INTO TABLE @DATA(IT_AUSP) FOR ALL ENTRIES IN @IT_MCH1 WHERE OBJEK = @IT_MCH1-OBJEK AND ATINN IN @LR_ATINN.
      ENDIF.
    ENDIF.


    COUNT = 1.
    LOOP AT IT_RESB1 INTO WA_RESB.
      WA_POT2-SR = COUNT.
      WA_POT2-CHARG = WA_RESB-CHARG.
      WA_POT2-STOCK = WA_RESB-ERFMG.
      WA_POT2-DQTY = WA_RESB-BDMNG.

      READ TABLE IT_QALS INTO WA_QALS WITH KEY CHARG = WA_RESB-CHARG MATNR = WA_RESB-MATNR.
      IF SY-SUBRC EQ 0.
        WA_POT2-PRUEFLOS = WA_QALS-PRUEFLOS.
      ELSE.
        SELECT SINGLE PRUEFLOS , MATNR , CHARG FROM ZINSP INTO @DATA(WA_INSP)
           WHERE MATNR = @WA_RESB-MATNR AND CHARG = @WA_RESB-CHARG.
        IF SY-SUBRC = 0.
          WA_POT2-PRUEFLOS = WA_INSP-PRUEFLOS.
        ENDIF.
      ENDIF.
      READ TABLE IT_MCH1 INTO WA_MCH1 WITH KEY CHARG = WA_RESB-CHARG MATNR = WA_RESB-MATNR.
      IF SY-SUBRC EQ 0.

        READ TABLE IT_AUSP INTO DATA(WA_AUSP) WITH KEY OBJEK = WA_MCH1-OBJEK.
        IF SY-SUBRC EQ 0.

          LV_P3 = WA_AUSP-DEC_VALUE_FROM.
          WA_POT2-P3 = LV_P3.
          IF MATNR EQ 'G15107' OR MATNR EQ 'G15108' OR MATNR EQ 'G15106'.
*           DATA(ced)  = 73206 / 1000.

            LV_NQTY = ( WA_RESB-ERFMG * WA_AUSP-DEC_VALUE_FROM ) / '73.206'.
            WA_POT2-NQTY1 = LV_NQTY.
          ELSE.
            LV_NQTY = ( WA_RESB-ERFMG * WA_AUSP-DEC_VALUE_FROM ) / 100.
            WA_POT2-NQTY1 = LV_NQTY.
          ENDIF.

        ENDIF.

      ENDIF.

      POTQTY11 = POTQTY11 + WA_POT2-NQTY1.
      POTQTY12 = POTQTY12 + WA_POT2-DQTY.

      APPEND WA_POT2 TO IT_POT2.

      READ TABLE IT_STPO INTO DATA(WA_STPO1) WITH KEY POSNR = WA_RESB-SORTF.
      IF SY-SUBRC EQ 0.
        ADJMATNR = WA_STPO1-IDNRK.
        PADJMENGE = WA_STPO1-MENGE.
        AMAKTX3 = LV_MAKTX.

        IF LV_MAKTX IS NOT INITIAL.
          CONCATENATE 'Qty of ' AMAKTX '+' LV_MAKTX '(kg)' INTO BMAKTX SEPARATED BY SPACE.
          CONDENSE BMAKTX.
          CLEAR : BMAKTX1.

          CONCATENATE 'Qty of ' AMAKTX  'dispenced' '(kg)' INTO BMAKTX1 SEPARATED BY SPACE.
          CONDENSE BMAKTX1.
          CLEAR : BMAKTX2.

          CONCATENATE 'Qty of ' LV_MAKTX 'dispenced' '(kg)' INTO BMAKTX2 SEPARATED BY SPACE.
          CONDENSE BMAKTX2.
        ENDIF.

        AAQTY1 = MENGE1 + PADJMENGE.
        AAQTY2 = POTQTY12.
        AAQTY3 = AAQTY1 - AAQTY2.
      ENDIF.

      COUNT = COUNT + 1.
      CLEAR WA_POT2.
    ENDLOOP.



  ENDIF.

  REFRESH :IT_RESB1, IT_MCH1, IT_AUSP.

ENDFORM.

FORM UPDATE_POT1.
  CLEAR : WA_POT1-DQTY, LV_P3, WA_POT1-P3, WA_POT1-NQTY1.
  SELECT * FROM AFPO INTO TABLE @DATA(IT_AFPO) WHERE MATNR = @MATNR AND CHARG = @BATCH.
  IF SY-SUBRC EQ 0.

    CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT'
      EXPORTING
        INPUT          = 'KAI'
        LANGUAGE       = SY-LANGU
      IMPORTING
        OUTPUT         = LV_ERFME
      EXCEPTIONS
        UNIT_NOT_FOUND = 1
        OTHERS         = 2.
    IF SY-SUBRC <> 0.
* Implement suitable error handling here
    ENDIF.


    SELECT * FROM RESB INTO TABLE @DATA(IT_RESB1)
      FOR ALL ENTRIES IN @IT_AFPO
      WHERE AUFNR = @IT_AFPO-AUFNR
      AND ERFME = @LV_ERFME
      AND CHARG NE @SPACE
      AND POSNR = @WA_MAT1-POSNR
      AND MATNR = @WA_MAT1-MATNR.



    IF SY-SUBRC EQ 0.

      SELECT CUOBJ_BM, MATNR, CHARG FROM MCH1 INTO TABLE @IT_MCH1 FOR ALL ENTRIES IN @IT_RESB1 WHERE MATNR = @IT_RESB1-MATNR AND CHARG = @IT_RESB1-CHARG.

      CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
        EXPORTING
          INPUT  = 'ZPOTENCY'
        IMPORTING
          OUTPUT = LV_ATINN.

      IF SY-SUBRC EQ 0.
        CLEAR LR_ATINN.
        LR_ATINN-SIGN = 'I'.        "Include
        LR_ATINN-OPTION = 'EQ'.     "Equal to
        LR_ATINN-LOW = LV_ATINN.    "Material number
        APPEND LR_ATINN.
      ENDIF.


*      IF sy-subrc NE 0.
      CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
        EXPORTING
          INPUT  = 'ZPOTENCY1'
        IMPORTING
          OUTPUT = LV_ATINN.

      IF SY-SUBRC EQ 0.
        CLEAR LR_ATINN.
        LR_ATINN-SIGN = 'I'.        "Include
        LR_ATINN-OPTION = 'EQ'.     "Equal to
        LR_ATINN-LOW = LV_ATINN.    "Material number
        APPEND LR_ATINN.
      ENDIF.

*      IF sy-subrc NE 0.
      CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
        EXPORTING
          INPUT  = 'ZPOTENCY2'
        IMPORTING
          OUTPUT = LV_ATINN.
      IF SY-SUBRC EQ 0.
        CLEAR LR_ATINN.
        LR_ATINN-SIGN = 'I'.        "Include
        LR_ATINN-OPTION = 'EQ'.     "Equal to
        LR_ATINN-LOW = LV_ATINN.    "Material number
        APPEND LR_ATINN.
      ENDIF.


      CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
        EXPORTING
          INPUT  = 'ZPOTENCY3'
        IMPORTING
          OUTPUT = LV_ATINN.
      IF SY-SUBRC EQ 0.
        CLEAR LR_ATINN.

        LR_ATINN-SIGN = 'I'.        "Include
        LR_ATINN-OPTION = 'EQ'.     "Equal to
        LR_ATINN-LOW = LV_ATINN.    "Material number
        APPEND LR_ATINN.
      ENDIF.


      CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
        EXPORTING
          INPUT  = 'ZPOTENCY4'
        IMPORTING
          OUTPUT = LV_ATINN.
      CLEAR LR_ATINN.
      LR_ATINN-SIGN = 'I'.        "Include
      LR_ATINN-OPTION = 'EQ'.     "Equal to
      LR_ATINN-LOW = LV_ATINN.    "Material number
      APPEND LR_ATINN.


      SELECT * FROM AUSP INTO TABLE @DATA(IT_AUSP) FOR ALL ENTRIES IN @IT_MCH1 WHERE OBJEK = @IT_MCH1-OBJEK AND ATINN IN @LR_ATINN.
    ENDIF.

    SELECT AUFNR, STLNR, STLAL FROM AFKO INTO TABLE @DATA(IT_AFKO) FOR ALL ENTRIES IN @IT_AFPO WHERE AUFNR = @IT_AFPO-AUFNR.
    IF SY-SUBRC EQ 0.

      SELECT STLKN, STLNR, STLAL FROM STAS INTO TABLE @DATA(IT_STAS) FOR ALL ENTRIES IN @IT_AFKO WHERE STLNR = @IT_AFKO-STLNR AND STLAL = @IT_AFKO-STLAL.
      IF SY-SUBRC EQ 0.

        READ TABLE IT_RESB1 INTO WA_RESB INDEX 1.
        IF SY-SUBRC EQ 0.

          SELECT IDNRK, MENGE, STLKN, STLNR, POSNR
            FROM STPO INTO TABLE @DATA(IT_STPO)
            FOR ALL ENTRIES IN @IT_STAS
            WHERE STLNR = @IT_STAS-STLNR
            AND STLKN = @IT_STAS-STLKN
            AND POSNR = @WA_RESB-SORTF.

        ENDIF.
      ENDIF.
    ENDIF.


    LOOP AT IT_RESB1 INTO WA_RESB.

      WA_POT1-DQTY = WA_RESB-BDMNG.

      READ TABLE IT_MCH1 INTO WA_MCH1 WITH KEY CHARG = WA_RESB-CHARG MATNR = WA_RESB-MATNR.
      IF SY-SUBRC EQ 0.

        READ TABLE IT_AUSP INTO DATA(WA_AUSP) WITH KEY OBJEK = WA_MCH1-OBJEK.
        IF SY-SUBRC EQ 0.

          LV_P3 = WA_AUSP-DEC_VALUE_FROM.
          WA_POT1-P3 = LV_P3.
          CONDENSE: WA_POT1-P3.

          LV_NQTY = ( WA_RESB-ERFMG * WA_AUSP-DEC_VALUE_FROM ) / 100.
          WA_POT1-NQTY1 = LV_NQTY.

        ENDIF.

      ENDIF.

      READ TABLE IT_STPO INTO DATA(WA_STPO1) WITH KEY POSNR = WA_RESB-SORTF.
      IF SY-SUBRC EQ 0.
        WA_MAT1-ADJMENGE = WA_STPO1-MENGE.
      ENDIF.

    ENDLOOP.

  ENDIF.

  REFRESH :IT_RESB1, IT_MCH1, IT_AUSP.

ENDFORM.
